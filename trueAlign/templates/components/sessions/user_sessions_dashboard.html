{% extends 'base.html' %} {% load static %} {% block content %}
<div class="min-h-screen bg-gray-50 p-8">
    <!-- Header -->
    <div class="mb-8 bg-white rounded-lg shadow-sm border border-gray-200 p-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-3">
                    UserSession Dashboard
                </h1>
                <p class="text-gray-600 text-lg">
                    Real-time monitoring and analytics for user sessions
                </p>
                <div class="text-sm text-gray-500 mt-3">
                    Last updated:
                    <span id="last-updated" class="font-medium text-gray-700"
                        >{{ current_time_ist|date:"Y-m-d H:i:s T" }}</span
                    >
                </div>
            </div>
            <div class="hidden md:block">
                <div
                    class="w-20 h-20 bg-blue-50 rounded-lg flex items-center justify-center"
                >
                    <svg
                        class="w-10 h-10 text-blue-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                        ></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">Filters</h2>
        <form
            id="filter-form"
            method="GET"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6"
        >
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700"
                    >Date Range</label
                >
                <select
                    name="date_range"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                >
                    {% for value, label in date_range_options %}
                    <option
                        value="{{ value }}"
                        {%
                        if
                        filters.date_range=""
                        ="value"
                        %}selected{%
                        endif
                        %}
                    >
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">Users</label>

                <!-- Selected Users Display -->
                <div id="selected-users-display" class="min-h-[42px] w-full px-4 py-3 border border-gray-300 rounded-lg bg-white flex flex-wrap gap-2 items-center">
                    <span id="no-users-selected" class="text-gray-500 text-sm">No users selected (All users will be shown)</span>
                </div>

                <!-- Hidden inputs for form submission -->
                <div id="user-hidden-inputs"></div>

                <!-- Open Modal Button -->
                <button
                    type="button"
                    onclick="openUserSelectionModal()"
                    class="w-full px-4 py-2 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 hover:bg-blue-100 transition-colors duration-200 flex items-center justify-center space-x-2"
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"></path>
                    </svg>
                    <span>Select Users</span>
                </button>
            </div>

            <!-- User Selection Modal -->
            <div id="userSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[80vh] flex flex-col">
                    <!-- Modal Header -->
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gray-50 rounded-t-xl">
                        <h3 class="text-lg font-semibold text-gray-900">Select Users</h3>
                        <button
                            type="button"
                            onclick="closeUserSelectionModal()"
                            class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
                        >
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Search Box -->
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="relative">
                            <input
                                type="text"
                                id="userSearchInput"
                                placeholder="Search users..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                oninput="filterUsers()"
                            >
                            <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="px-6 py-3 border-b border-gray-200 bg-gray-50">
                        <div class="flex space-x-2">
                            <button
                                type="button"
                                onclick="selectAllUsers()"
                                class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors duration-200"
                            >
                                Select All
                            </button>
                            <button
                                type="button"
                                onclick="clearAllUsers()"
                                class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors duration-200"
                            >
                                Clear All
                            </button>
                        </div>
                    </div>

                    <!-- Users List -->
                    <div class="overflow-y-auto px-6 py-4 h-96">
                        <div id="usersList" class="space-y-2">
                            {% for user in users_list %}
                            <label class="user-item flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-200" data-username="{{ user.username|lower }}">
                                <input
                                    type="checkbox"
                                    value="{{ user.id }}"
                                    data-username="{{ user.username }}"
                                    onchange="updateSelectedUsers()"
                                    class="user-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                    {% if user.id|stringformat:"s" in filters.user %}checked{% endif %}
                                >
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ user.username }}</div>
                                        {% if user.first_name or user.last_name %}
                                        <div class="text-xs text-gray-500">{{ user.first_name }} {{ user.last_name }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                        <div id="noUsersFound" class="hidden text-center py-8 text-gray-500">
                            <svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                            <p>No users found</p>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                        <div class="flex justify-between items-center">
                            <span id="selectedCount" class="text-sm text-gray-600">0 users selected</span>
                            <div class="flex space-x-3">
                                <button
                                    type="button"
                                    onclick="closeUserSelectionModal()"
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="button"
                                    onclick="applyUserSelection()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
                                >
                                    Apply Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                let selectedUsers = new Set();

                // Initialize selected users on page load
                document.addEventListener('DOMContentLoaded', function() {
                    // Check for pre-selected users from filters
                    const checkboxes = document.querySelectorAll('.user-checkbox');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            selectedUsers.add({
                                id: checkbox.value,
                                username: checkbox.dataset.username
                            });
                        }
                    });
                    updateSelectedUsersDisplay();
                    updateSelectedCount();
                });

                function openUserSelectionModal() {
                    document.getElementById('userSelectionModal').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    document.getElementById('userSearchInput').focus();
                }

                function closeUserSelectionModal() {
                    document.getElementById('userSelectionModal').classList.add('hidden');
                    document.body.style.overflow = '';
                    document.getElementById('userSearchInput').value = '';
                    filterUsers();
                }

                function filterUsers() {
                    const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
                    const userItems = document.querySelectorAll('.user-item');
                    let visibleCount = 0;

                    userItems.forEach(item => {
                        const username = item.dataset.username;
                        if (username.includes(searchTerm)) {
                            item.style.display = 'flex';
                            visibleCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    });

                    document.getElementById('noUsersFound').classList.toggle('hidden', visibleCount > 0);
                }

                function updateSelectedUsers() {
                    selectedUsers.clear();
                    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
                    checkboxes.forEach(checkbox => {
                        selectedUsers.add({
                            id: checkbox.value,
                            username: checkbox.dataset.username
                        });
                    });
                    updateSelectedCount();
                }

                function updateSelectedCount() {
                    const count = selectedUsers.size;
                    document.getElementById('selectedCount').textContent = `${count} user${count !== 1 ? 's' : ''} selected`;
                }

                function selectAllUsers() {
                    const visibleCheckboxes = document.querySelectorAll('.user-item:not([style*="display: none"]) .user-checkbox');
                    visibleCheckboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    updateSelectedUsers();
                }

                function clearAllUsers() {
                    const checkboxes = document.querySelectorAll('.user-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    updateSelectedUsers();
                }

                function applyUserSelection() {
                    updateSelectedUsersDisplay();
                    updateHiddenInputs();
                    closeUserSelectionModal();
                }

                function updateSelectedUsersDisplay() {
                    const displayContainer = document.getElementById('selected-users-display');
                    const noUsersSpan = document.getElementById('no-users-selected');

                    if (selectedUsers.size === 0) {
                        displayContainer.innerHTML = '<span id="no-users-selected" class="text-gray-500 text-sm">No users selected (All users will be shown)</span>';
                    } else {
                        const userTags = Array.from(selectedUsers).map(user => {
                            return `
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${user.username}
                                    <button type="button" onclick="removeUser('${user.id}')" class="ml-1 text-blue-600 hover:text-blue-800">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </span>
                            `;
                        }).join('');
                        displayContainer.innerHTML = userTags;
                    }
                }

                function updateHiddenInputs() {
                    const container = document.getElementById('user-hidden-inputs');
                    container.innerHTML = '';

                    selectedUsers.forEach(user => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'user';
                        input.value = user.id;
                        container.appendChild(input);
                    });
                }

                function removeUser(userId) {
                    selectedUsers = new Set(Array.from(selectedUsers).filter(user => user.id !== userId));

                    // Uncheck the checkbox in the modal
                    const checkbox = document.querySelector(`.user-checkbox[value="${userId}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }

                    updateSelectedUsersDisplay();
                    updateHiddenInputs();
                    updateSelectedCount();
                }

                // Close modal when clicking outside
                document.getElementById('userSelectionModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeUserSelectionModal();
                    }
                });

                // Close modal with Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && !document.getElementById('userSelectionModal').classList.contains('hidden')) {
                        closeUserSelectionModal();
                    }
                });
            </script>
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700"
                    >Device Type</label
                >
                <select
                    name="device_type"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                >
                    <option value="">All Devices</option>
                    <option value="desktop" {% if filters.device_type == "desktop" %}selected{% endif %}>Desktop</option>
                    <option value="mobile" {% if filters.device_type == "mobile" %}selected{% endif %}>Mobile</option>
                    <option value="tablet" {% if filters.device_type == "tablet" %}selected{% endif %}>Tablet</option>
                </select>
            </div>
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700"
                    >Location</label
                >
                <select
                    name="location"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                >
                    <option value="">All Locations</option>
                    {% for location in locations %}
                    <option
                        value="{{ location }}"
                        {% if filters.location == location %}selected{% endif %}
                    >
                        {{ location }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="xl:col-span-2 flex items-end space-x-4">
                <button
                    type="submit"
                    class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                >
                    Apply Filters
                </button>
                <button
                    type="reset"
                    class="px-6 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 bg-white transition-colors"
                >
                    Reset
                </button>
            </div>
        </form>
    </div>

    <!-- Overview Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Active Sessions Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-2">
                        Active Sessions
                    </p>
                    <div class="flex items-baseline space-x-2">
                        <p
                            class="text-3xl font-bold text-gray-900"
                            id="active-sessions"
                        >
                            {{ overview_metrics.active_sessions }}
                        </p>
                        <span
                            class="text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded"
                            >+2.5%</span
                        >
                    </div>
                </div>
                <div
                    class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center"
                >
                    <svg
                        class="w-6 h-6 text-green-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd"
                        ></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Avg Session Duration Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-2">
                        Avg Session Duration
                    </p>
                    <p class="text-3xl font-bold text-gray-900">
                        {{ overview_metrics.avg_session_duration|floatformat:1}}h
                    </p>
                </div>
                <div
                    class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center"
                >
                    <svg
                        class="w-6 h-6 text-blue-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                            clip-rule="evenodd"
                        ></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Avg Productivity Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-2">
                        Avg Productivity
                    </p>
                    <p class="text-3xl font-bold text-gray-900">
                        {{ overview_metrics.avg_productivity|floatformat:0 }}%
                    </p>
                </div>
                <div
                    class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center"
                >
                    <svg
                        class="w-6 h-6 text-purple-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                        <path
                            d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"
                        ></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Security Incidents Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-600 mb-2">
                        Security Incidents
                    </p>
                    <p class="text-3xl font-bold text-gray-900">
                        {{ security_insights.total_incidents }}
                    </p>
                </div>
                <div
                    class="w-12 h-12 bg-red-50 rounded-lg flex items-center justify-center"
                >
                    <svg
                        class="w-6 h-6 text-red-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd"
                        ></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Live Activity Feed -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div
                    class="px-6 py-4 border-b border-gray-200 flex items-center justify-between"
                >
                    <h2 class="text-xl font-semibold text-gray-900">
                        Live Activity Feed
                    </h2>
                    <button
                        onclick="refreshLiveActivity()"
                        class="text-sm text-blue-600 hover:text-blue-800 font-medium px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors"
                    >
                        <svg
                            class="w-4 h-4 inline mr-1"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                        Refresh
                    </button>
                </div>
                <div class="p-6">
                    <div
                        id="live-activity-container"
                        class="space-y-4 max-h-96 overflow-y-auto"
                    >
                        {% for activity in live_activity_data %}
                        <div
                            class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100"
                        >
                            <div class="flex items-center space-x-4">
                                <div
                                    class="w-3 h-3 rounded-full {% if activity.activity_status == 'active' %}bg-green-500{% elif activity.activity_status == 'idle' %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                                ></div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-gray-900"
                                    >
                                        {{ activity.user.username }}
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        {{ activity.current_url|truncatechars:50}}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-900">
                                    {{ activity.session_duration_minutes }}m
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    {{ activity.device_type }}
                                </p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-12">
                            <svg
                                class="w-12 h-12 text-gray-300 mx-auto mb-4"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            <p class="text-gray-500 text-lg">
                                No active sessions
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Analytics Summary -->
        <div class="space-y-8">
            <!-- User Insights -->
            <div
                class="bg-gradient-to-br from-white to-blue-50/30 rounded-xl shadow-sm border border-blue-100/50 hover:shadow-md transition-all duration-300"
            >
                <div
                    class="px-6 py-4 border-b border-blue-100/50 bg-white/50 rounded-t-xl"
                >
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center"
                        >
                            <svg
                                class="w-4 h-4 text-blue-600"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                                ></path>
                            </svg>
                        </div>
                        <h3
                            class="text-lg font-semibold text-slate-800 tracking-tight"
                        >
                            Top Users
                        </h3>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        {% for insight in user_insights|slice:":5" %}
                        <div
                            class="flex items-center justify-between p-3 bg-white/60 rounded-lg border border-blue-50 hover:bg-white/80 transition-colors duration-200"
                        >
                            <div class="flex items-center space-x-3">
                                <div
                                    class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center"
                                >
                                    <svg
                                        class="w-4 h-4 text-white"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                            clip-rule="evenodd"
                                        ></path>
                                    </svg>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-slate-800"
                                    >
                                        {{ insight.username }}
                                    </p>
                                    <p
                                        class="text-xs text-slate-500 font-normal"
                                    >
                                        {{ insight.total_sessions }} sessions
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-slate-800">
                                    {{ insight.avg_productivity|floatformat:0 }}%
                                </p>
                                <p class="text-xs text-slate-500 font-normal">
                                    {{ insight.total_hours|floatformat:1 }}h
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Device Distribution -->
            <div
                class="bg-gradient-to-br from-white to-emerald-50/30 rounded-xl shadow-sm border border-emerald-100/50 hover:shadow-md transition-all duration-300"
            >
                <div
                    class="px-6 py-4 border-b border-emerald-100/50 bg-white/50 rounded-t-xl"
                >
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-8 h-8 bg-emerald-500/10 rounded-lg flex items-center justify-center"
                        >
                            <svg
                                class="w-4 h-4 text-emerald-600"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                        </div>
                        <h3
                            class="text-lg font-semibold text-slate-800 tracking-tight"
                        >
                            Device Types
                        </h3>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <div
                            class="flex items-center justify-between p-3 bg-white/60 rounded-lg border border-emerald-50 hover:bg-white/80 transition-colors duration-200"
                        >
                            <div class="flex items-center space-x-3">
                                <svg
                                    class="w-5 h-5 text-emerald-600"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z"
                                        clip-rule="evenodd"
                                    ></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700"
                                    >Desktop</span
                                >
                            </div>
                            <span
                                class="text-sm font-semibold text-slate-800 bg-emerald-100 px-2 py-1 rounded-full"
                            >
                                {{ security_insights.device_distribution.desktop|default:0 }}
                            </span>
                        </div>
                        <div
                            class="flex items-center justify-between p-3 bg-white/60 rounded-lg border border-emerald-50 hover:bg-white/80 transition-colors duration-200"
                        >
                            <div class="flex items-center space-x-3">
                                <svg
                                    class="w-5 h-5 text-emerald-600"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1V7zM9 11a1 1 0 102 0 1 1 0 00-2 0z"
                                    ></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700"
                                    >Mobile</span
                                >
                            </div>
                            <span
                                class="text-sm font-semibold text-slate-800 bg-emerald-100 px-2 py-1 rounded-full"
                            >
                                {{ security_insights.device_distribution.mobile|default:0 }}
                            </span>
                        </div>
                        <div
                            class="flex items-center justify-between p-3 bg-white/60 rounded-lg border border-emerald-50 hover:bg-white/80 transition-colors duration-200"
                        >
                            <div class="flex items-center space-x-3">
                                <svg
                                    class="w-5 h-5 text-emerald-600"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z"
                                        clip-rule="evenodd"
                                    ></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700"
                                    >Tablet</span
                                >
                            </div>
                            <span
                                class="text-sm font-semibold text-slate-800 bg-emerald-100 px-2 py-1 rounded-full"
                            >
                                {{ security_insights.device_distribution.tablet|default:0 }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Distribution -->
            <div
                class="bg-gradient-to-br from-white to-purple-50/30 rounded-xl shadow-sm border border-purple-100/50 hover:shadow-md transition-all duration-300"
            >
                <div
                    class="px-6 py-4 border-b border-purple-100/50 bg-white/50 rounded-t-xl"
                >
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-8 h-8 bg-purple-500/10 rounded-lg flex items-center justify-center"
                        >
                            <svg
                                class="w-4 h-4 text-purple-600"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                        </div>
                        <h3
                            class="text-lg font-semibold text-slate-800 tracking-tight"
                        >
                            Locations
                        </h3>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        {% for location, count in location_insights.location_distribution.items %}
                        <div
                            class="flex items-center justify-between p-3 bg-white/60 rounded-lg border border-purple-50 hover:bg-white/80 transition-colors duration-200"
                        >
                            <div class="flex items-center space-x-3">
                                <svg
                                    class="w-5 h-5 text-purple-600"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                        clip-rule="evenodd"
                                    ></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700"
                                    >{{ location }}</span
                                >
                            </div>
                            <span
                                class="text-sm font-semibold text-slate-800 bg-purple-100 px-2 py-1 rounded-full"
                                >{{ count }}</span
                            >
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Tabs -->
    <div class="mt-10">
        <div class="border-b border-slate-200/60 bg-white/50 rounded-t-xl">
            <nav class="-mb-px flex space-x-8 px-6">
                <button
                    onclick="showTab('sessions')"
                    class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-semibold text-sm text-blue-600 tracking-tight flex items-center space-x-2"
                >
                    <svg
                        class="w-4 h-4"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    <span>Sessions</span>
                </button>
                <button
                    onclick="showTab('analytics')"
                    class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 tracking-tight flex items-center space-x-2 transition-colors duration-200"
                >
                    <svg
                        class="w-4 h-4"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                        <path
                            d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"
                        ></path>
                    </svg>
                    <span>Analytics</span>
                </button>
                <button
                    onclick="showTab('security')"
                    class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 tracking-tight flex items-center space-x-2 transition-colors duration-200"
                >
                    <svg
                        class="w-4 h-4"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd"
                        ></path>
                    </svg>
                    <span>Security</span>
                </button>
                <button
                    onclick="showTab('performance')"
                    class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300 tracking-tight flex items-center space-x-2 transition-colors duration-200"
                >
                    <svg
                        class="w-4 h-4"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                            clip-rule="evenodd"
                        ></path>
                    </svg>
                    <span>Performance</span>
                </button>
            </nav>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions-tab" class="tab-content mt-6">
            <div
                class="bg-white rounded-xl shadow-sm border border-slate-200/60"
            >
                <div
                    class="px-6 py-4 border-b border-slate-200/60 flex items-center justify-between bg-slate-50/50 rounded-t-xl"
                >
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center"
                        >
                            <svg
                                class="w-4 h-4 text-blue-600"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                ></path>
                            </svg>
                        </div>
                        <h3
                            class="text-lg font-semibold text-slate-800 tracking-tight"
                        >
                            Session Details
                        </h3>
                    </div>
                    <div class="flex space-x-3">
                        <button
                            onclick="exportData('csv')"
                            class="inline-flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-800 font-medium px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors duration-200"
                        >
                            <svg
                                class="w-4 h-4"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            <span>Export CSV</span>
                        </button>
                        <button
                            onclick="exportData('excel')"
                            class="inline-flex items-center space-x-2 text-sm text-emerald-600 hover:text-emerald-800 font-medium px-3 py-2 rounded-lg hover:bg-emerald-50 transition-colors duration-200"
                        >
                            <svg
                                class="w-4 h-4"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            <span>Export Excel</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200/60">
                        <thead class="bg-slate-50/80">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    User
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    Login Time
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    Duration
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    Device
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    Location
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    Productivity
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    Status
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider"
                                >
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-100">
                            {% for session_data in sessions_display %}
                            <tr
                                class="hover:bg-slate-50/60 transition-colors duration-200"
                            >
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-3">
                                        <div
                                            class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center"
                                        >
                                            <svg
                                                class="w-4 h-4 text-white"
                                                fill="currentColor"
                                                viewBox="0 0 20 20"
                                            >
                                                <path
                                                    fill-rule="evenodd"
                                                    d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                                    clip-rule="evenodd"
                                                ></path>
                                            </svg>
                                        </div>
                                        <div
                                            class="text-sm font-medium text-slate-800"
                                        >
                                            {{ session_data.session.user.username }}
                                        </div>
                                    </div>
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-medium"
                                >
                                    {{ session_data.login_time_ist|date:"M d, H:i" }}
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-medium"
                                >
                                    {{ session_data.current_duration_minutes|floatformat:0 }}m
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-medium"
                                >
                                    {{ session_data.session.device_type|title }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {% if session_data.session.location == 'Office' %}bg-emerald-100 text-emerald-800{% else %}bg-amber-100 text-amber-800{% endif %}"
                                    >
                                        {{ session_data.session.location|default:"Unknown" }}
                                    </span>
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-semibold"
                                >
                                    {{ session_data.session.productivity_score|default:0|floatformat:0 }}%
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {% if session_data.session.is_active %}bg-emerald-100 text-emerald-800{% else %}bg-slate-100 text-slate-700{% endif %}"
                                    >
                                        {% if session_data.session.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                                >
                                    <a
                                        href="{% url 'aps_admin:user_session_detail' session_data.session.user.id session_data.login_time_ist.date %}"
                                        class="inline-flex items-center space-x-1 text-blue-600 hover:text-blue-800 font-medium px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors duration-200"
                                    >
                                        <svg
                                            class="w-4 h-4"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                d="M10 12a2 2 0 100-4 2 2 0 000 4z"
                                            ></path>
                                            <path
                                                fill-rule="evenodd"
                                                d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                                clip-rule="evenodd"
                                            ></path>
                                        </svg>
                                        <span>View Details</span>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                {% if sessions_page.has_other_pages %}
                <div
                    class="px-6 py-4 border-t border-slate-200/60 flex items-center justify-between bg-slate-50/30"
                >
                    <div class="flex-1 flex justify-between sm:hidden">
                        {% if sessions_page.has_previous %}
                        <a
                            href="?page={{ sessions_page.previous_page_number }}"
                            class="relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 transition-colors duration-200"
                            >Previous</a
                        >
                        {% endif %} {% if sessions_page.has_next %}
                        <a
                            href="?page={{ sessions_page.next_page_number }}"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 transition-colors duration-200"
                            >Next</a
                        >
                        {% endif %}
                    </div>
                    <div
                        class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between"
                    >
                        <div>
                            <p class="text-sm text-slate-600 font-medium">
                                Showing
                                <span class="font-semibold text-slate-800"
                                    >{{ sessions_page.start_index }}</span
                                >
                                to
                                <span class="font-semibold text-slate-800"
                                    >{{ sessions_page.end_index }}</span
                                >
                                of
                                <span class="font-semibold text-slate-800"
                                    >{{ sessions_page.paginator.count }}</span
                                >
                                results
                            </p>
                        </div>
                        <div>
                            <nav
                                class="relative z-0 inline-flex rounded-lg shadow-sm -space-x-px"
                            >
                                {% if sessions_page.has_previous %}
                                <a
                                    href="?page={{ sessions_page.previous_page_number }}"
                                    class="relative inline-flex items-center px-3 py-2 rounded-l-lg border border-slate-300 bg-white text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors duration-200"
                                    >Previous</a
                                >
                                {% endif %} {% for num in sessions_page.paginator.page_range %} {% if sessions_page.number == num %}
                                <span
                                    class="relative inline-flex items-center px-4 py-2 border border-slate-300 bg-blue-50 text-sm font-semibold text-blue-600"
                                    >{{ num }}</span
                                >
                                {% else %}
                                <a
                                    href="?page={{ num }}"
                                    class="relative inline-flex items-center px-4 py-2 border border-slate-300 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors duration-200"
                                    >{{ num }}</a
                                >
                                {% endif %} {% endfor %} {% if sessions_page.has_next %}
                                <a
                                    href="?page={{ sessions_page.next_page_number }}"
                                    class="relative inline-flex items-center px-3 py-2 rounded-r-lg border border-slate-300 bg-white text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors duration-200"
                                    >Next</a
                                >
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content mt-6 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Tab Behavior Analysis
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Avg Tab Switches:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ tab_analysis.avg_tab_switches|floatformat:1 }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Avg Focus Time:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ tab_analysis.avg_focus_time|floatformat:1 }}m</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Multi-tab Sessions:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ tab_analysis.multi_tab_sessions }}</span
                            >
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Engagement Metrics
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Avg Engagement Score:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                quality_insights.avg_engagement|floatformat:0
                                }}%</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >High Quality Sessions:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ quality_insights.high_quality_sessions
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Low Quality Sessions:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ quality_insights.low_quality_sessions
                                }}</span
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div id="security-tab" class="tab-content mt-6 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Security Overview -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Security Overview
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Unique IPs:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ security_insights.unique_ips }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Suspicious Activities:</span
                            >
                            <span class="text-sm font-medium text-red-600"
                                >{{ security_insights.suspicious_activities
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Failed Logins:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ security_insights.failed_logins|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >CSRF Incidents:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ security_insights.csrf_incidents|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Fingerprint Mismatches:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                security_insights.fingerprint_mismatches|default:0
                                }}</span
                            >
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Risk Assessment
                    </h4>
                    <div class="space-y-3">
                        {% if security_insights.risk_level == 'high' %}
                        <div class="flex items-center text-red-600">
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            High Risk
                        </div>
                        {% elif security_insights.risk_level == 'medium' %}
                        <div class="flex items-center text-yellow-600">
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            Medium Risk
                        </div>
                        {% else %}
                        <div class="flex items-center text-green-600">
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            Low Risk
                        </div>
                        {% endif %}
                        <div class="mt-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600"
                                    >Security Score:</span
                                >
                                <span class="font-medium"
                                    >{{
                                    security_insights.security_score|default:85
                                    }}%</span
                                >
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div
                                    class="h-2 rounded-full {% if security_insights.security_score >= 80 %}bg-green-600{% elif security_insights.security_score >= 60 %}bg-yellow-600{% else %}bg-red-600{% endif %}"
                                    style="width: {{ security_insights.security_score|default:85 }}%"
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IP & Location Analysis -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        IP & Location Analysis
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Office IPs:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ security_insights.office_ip_count|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >External IPs:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                security_insights.external_ip_count|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >VPN Detected:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ security_insights.vpn_sessions|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Unknown Locations:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                security_insights.unknown_locations|default:0
                                }}</span
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Incidents Table -->
            <div class="mt-6 bg-white rounded-lg shadow-sm border">
                <div
                    class="px-4 py-3 border-b border-gray-200 flex items-center justify-between"
                >
                    <h4 class="text-lg font-semibold text-gray-900">
                        Recent Security Incidents
                    </h4>
                    <button
                        onclick="refreshSecurityIncidents()"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >
                                    User
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >
                                    Incident Type
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >
                                    IP Address
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >
                                    Time
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >
                                    Severity
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for incident in security_insights.recent_incidents %}
                            <tr class="hover:bg-gray-50">
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                >
                                    {{ incident.user.username }}
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                >
                                    {{ incident.incident_type|title }}
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                >
                                    {{ incident.ip_address }}
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                >
                                    {{ incident.timestamp|date:"M d, H:i" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if incident.severity == 'high' %}bg-red-100 text-red-800{% elif incident.severity == 'medium' %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}"
                                    >
                                        {{ incident.severity|title }}
                                    </span>
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                                >
                                    <a
                                        href="#"
                                        onclick="investigateIncident('{{ incident.id }}')"
                                        class="text-blue-600 hover:text-blue-900"
                                        >Investigate</a
                                    >
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td
                                    colspan="6"
                                    class="px-6 py-4 text-center text-sm text-gray-500"
                                >
                                    No security incidents found
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Browser Fingerprint Analysis -->
            <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Browser Fingerprint Analysis
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Unique Fingerprints:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                security_insights.unique_fingerprints|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Fingerprint Changes:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                security_insights.fingerprint_changes|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Suspicious Changes:</span
                            >
                            <span class="text-sm font-medium text-red-600"
                                >{{
                                security_insights.suspicious_fingerprint_changes|default:0
                                }}</span
                            >
                        </div>
                    </div>
                </div>

                <!-- Session Security Metrics -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Session Security
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Secure Sessions:</span
                            >
                            <span class="text-sm font-medium text-green-600"
                                >{{ security_insights.secure_sessions|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Insecure Sessions:</span
                            >
                            <span class="text-sm font-medium text-red-600"
                                >{{
                                security_insights.insecure_sessions|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Multi-device Users:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                security_insights.multi_device_users|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Concurrent Sessions:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                security_insights.concurrent_sessions|default:0
                                }}</span
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performance-tab" class="tab-content mt-6 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Response Times
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Avg Load Time:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                performance_insights.avg_load_time|floatformat:2
                                }}s</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Slow Requests:</span
                            >
                            <span class="text-sm font-medium text-red-600"
                                >{{ performance_insights.slow_requests|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Error Rate:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                performance_insights.error_rate|floatformat:1
                                }}%</span
                            >
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Network Performance
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Avg Network Latency:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                performance_insights.avg_network_latency|default:0
                                }}ms</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Connection Timeouts:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                performance_insights.connection_timeouts|default:0
                                }}</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Data Transfer (MB):</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                performance_insights.data_transfer|floatformat:1
                                }}</span
                            >
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        System Health
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Memory Usage:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ performance_insights.memory_usage|default:0
                                }}%</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >CPU Usage:</span
                            >
                            <span class="text-sm font-medium"
                                >{{ performance_insights.cpu_usage|default:0
                                }}%</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600"
                                >Active Connections:</span
                            >
                            <span class="text-sm font-medium"
                                >{{
                                performance_insights.active_connections|default:0
                                }}</span
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((tab) => {
            tab.classList.add("hidden");
        });

        // Remove active class from all tab buttons
        document.querySelectorAll(".tab-button").forEach((button) => {
            button.classList.remove(
                "active",
                "border-blue-500",
                "text-blue-600",
            );
            button.classList.add("border-transparent", "text-gray-500");
        });

        // Show selected tab
        document.getElementById(tabName + "-tab").classList.remove("hidden");

        // Add active class to clicked button
        event.target.classList.add(
            "active",
            "border-blue-500",
            "text-blue-600",
        );
        event.target.classList.remove("border-transparent", "text-gray-500");
    }

    function refreshLiveActivity() {
        fetch(window.location.href + "?type=live_activity", {
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            },
        })
            .then((response) => response.json())
            .then((data) => {
                document.getElementById("live-activity-container").innerHTML =
                    data.html;
                document.getElementById("last-updated").textContent =
                    new Date().toLocaleString();
            })
            .catch((error) =>
                console.error("Error refreshing live activity:", error),
            );
    }

    function refreshSecurityIncidents() {
        fetch(window.location.href + "?type=security_incidents", {
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            },
        })
            .then((response) => response.json())
            .then((data) => {
                location.reload(); // Simple refresh for now
            })
            .catch((error) =>
                console.error("Error refreshing security incidents:", error),
            );
    }

    function investigateIncident(incidentId) {
        // Placeholder for incident investigation
        alert("Investigating incident: " + incidentId);
    }

    function exportData(format) {
        const params = new URLSearchParams(window.location.search);
        params.set("export", format);
        window.location.href =
            window.location.pathname + "?" + params.toString();
    }

    // Auto-refresh live activity every 30 seconds
    setInterval(refreshLiveActivity, 30000);
</script>

{% endblock %}
