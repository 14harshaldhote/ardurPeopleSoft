{% extends "base.html" %} {% block title %}{{ dashboard_title|default:"Support
Dashboard" }}{% endblock %} {% block head_extras %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
/>
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
/>
{% endblock %} {% block content %}
<div
    class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-emerald-50 font-sans px-4 py-8"
>
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-10"
        >
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    {% if role_type == 'admin' %}
                    <svg
                        class="w-12 h-12 text-red-500"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                    >
                        <path
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                        />
                    </svg>
                    {% elif role_type == 'manager' %}
                    <svg
                        class="w-12 h-12 text-purple-500"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                    >
                        <path
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                        />
                    </svg>
                    {% elif role_type == 'hr' %}
                    <svg
                        class="w-12 h-12 text-green-500"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                    >
                        <path
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        />
                    </svg>
                    {% else %}
                    <svg
                        class="w-12 h-12 text-blue-500"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                    >
                        <path
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        />
                    </svg>
                    {% endif %}
                </div>
                <div>
                    <h1
                        class="text-4xl font-extrabold text-gray-800 tracking-tight"
                        id="main-content"
                    >
                        {{ dashboard_title|default:"Support Dashboard" }}
                    </h1>
                    <div class="flex items-center gap-2 mt-2">
                        {% if user_roles.is_admin %}
                        <span
                            class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-sm font-semibold"
                            >Admin</span
                        >
                        {% elif user_roles.is_manager %}
                        <span
                            class="px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-sm font-semibold"
                            >Manager</span
                        >
                        {% elif user_roles.is_hr %}
                        <span
                            class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-semibold"
                            >HR</span
                        >
                        {% elif user_roles.is_it_support %}
                        <span
                            class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm font-semibold"
                            >IT Support</span
                        >
                        {% else %}
                        <span
                            class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm font-semibold"
                            >Employee</span
                        >
                        {% endif %}
                        <span
                            class="px-2 py-1 rounded bg-blue-50 text-blue-600 text-xs font-medium"
                        >
                            {{current_user.get_full_name|default:current_user.username }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Date Filter Form -->
            <form
                method="get"
                class="flex flex-wrap items-center gap-3 bg-white/90 rounded-xl shadow-lg p-4 backdrop-blur"
            >
                <label
                    for="date_range"
                    class="text-sm font-medium text-gray-600"
                    >Date Range:</label
                >
                <select
                    name="date_range"
                    id="date_range"
                    class="rounded-lg border border-gray-200 py-2 px-3 text-sm focus:ring-2 focus:ring-blue-200 bg-white"
                >
                    <option
                        value="last_7_days"
                        {%
                        if
                        date_range=""
                        ="last_7_days"
                        %}selected{%
                        endif
                        %}
                    >
                        Last 7 Days
                    </option>
                    <option
                        value="last_30_days"
                        {%
                        if
                        date_range=""
                        ="last_30_days"
                        %}selected{%
                        endif
                        %}
                    >
                        Last 30 Days
                    </option>
                    <option
                        value="last_90_days"
                        {%
                        if
                        date_range=""
                        ="last_90_days"
                        %}selected{%
                        endif
                        %}
                    >
                        Last 90 Days
                    </option>
                    <option
                        value="year_to_date"
                        {%
                        if
                        date_range=""
                        ="year_to_date"
                        %}selected{%
                        endif
                        %}
                    >
                        Year to Date
                    </option>
                    <option
                        value="custom"
                        {%
                        if
                        date_range=""
                        ="custom"
                        %}selected{%
                        endif
                        %}
                    >
                        Custom
                    </option>
                </select>
                <div
                    class="flex items-center gap-2 {% if date_range != 'custom' %}hidden{% endif %}"
                    id="custom-date-container"
                >
                    <input
                        type="text"
                        name="from_date"
                        id="from_date"
                        placeholder="From"
                        value="{{ from_date|date:'Y-m-d' }}"
                        class="rounded-lg border border-gray-200 py-2 px-3 text-sm w-32"
                    />
                    <span class="text-gray-400">to</span>
                    <input
                        type="text"
                        name="to_date"
                        id="to_date"
                        placeholder="To"
                        value="{{ to_date|date:'Y-m-d' }}"
                        class="rounded-lg border border-gray-200 py-2 px-3 text-sm w-32"
                    />
                </div>
                <button
                    type="submit"
                    class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-2 rounded-lg text-sm font-semibold shadow-lg transition"
                >
                    Apply
                </button>
            </form>
        </header>

        <!-- Role-Specific Metrics Cards -->
        {% if role_type == 'admin' %}
        <!-- Admin Metrics -->
        <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6 mb-10"
        >
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-blue-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-blue-600 mb-2">
                    {{ stats.total_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Total Tickets
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-yellow-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-yellow-600 mb-2">
                    {{ stats.open_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Open Tickets
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-red-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-red-600 mb-2">
                    {{ stats.overdue_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">Overdue</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-gray-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-gray-600 mb-2">
                    {{ stats.unassigned_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">Unassigned</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-orange-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-orange-600 mb-2">
                    {{ stats.breached_sla|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    SLA Breached
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-purple-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-purple-600 mb-2">
                    {{ stats.escalated_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">Escalated</div>
            </div>
        </div>
        {% elif role_type == 'manager' %}
        <!-- Manager Metrics -->
        <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6 mb-10"
        >
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-blue-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-blue-600 mb-2">
                    {{ stats.total_team_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Team Tickets
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-yellow-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-yellow-600 mb-2">
                    {{ stats.open_team_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">Open Team</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-red-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-red-600 mb-2">
                    {{ stats.overdue_team_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Overdue Team
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-green-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-green-600 mb-2">
                    {{ stats.my_assignments|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    My Assignments
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-purple-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-purple-600 mb-2">
                    {{ stats.team_members|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Team Members
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-orange-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-orange-600 mb-2">
                    {{ stats.escalated_to_me|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Escalated to Me
                </div>
            </div>
        </div>
        {% elif role_type == 'hr' %}
        <!-- HR Metrics -->
        <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6 mb-10"
        >
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-green-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-green-600 mb-2">
                    {{ stats.total_hr_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">HR Tickets</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-yellow-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-yellow-600 mb-2">
                    {{ stats.open_hr_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">Open HR</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-blue-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-blue-600 mb-2">
                    {{ stats.access_requests|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Access Requests
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-purple-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-purple-600 mb-2">
                    {{ stats.hr_issues|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">HR Issues</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-red-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-red-600 mb-2">
                    {{ stats.my_assignments|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    My Assignments
                </div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-orange-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-orange-600 mb-2">
                    {{ stats.pending_approval|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Pending Approval
                </div>
            </div>
        </div>
        {% else %}
        <!-- Employee Metrics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-blue-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-blue-600 mb-2">
                    {{ stats.total_my_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">My Tickets</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-yellow-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-yellow-600 mb-2">
                    {{ stats.open_my_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">Open</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-green-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-green-600 mb-2">
                    {{ stats.resolved_my_tickets|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">Resolved</div>
            </div>
            <div
                class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center border-l-4 border-red-500 hover:scale-105 transition-transform backdrop-blur"
            >
                <div class="text-3xl font-bold text-red-600 mb-2">
                    {{ stats.pending_response|default:0 }}
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    Need Response
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="flex flex-wrap gap-3 mb-10">
            {% for action in quick_actions %}
            <a
                href="{% if action.url != '#' %}{% url action.url %}{% else %}#{% endif %}"
                class="inline-flex items-center gap-2 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-5 py-3 rounded-xl font-semibold shadow-lg transition transform hover:scale-105"
            >
                <i class="{{ action.icon }} w-5 h-5"></i>
                {{ action.title }}
            </a>
            {% endfor %}
        </div>

        <!-- Performance Metrics Section -->
        {% if performance_metrics %}
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                Performance Overview
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div
                    class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur"
                >
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">
                        Today's Activity
                    </h3>
                    <div class="flex justify-between">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">
                                {{ performance_metrics.today_created|default:0}}
                            </div>
                            <div class="text-xs text-gray-500">Created</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">
                                {{ performance_metrics.today_resolved|default:0 }}
                            </div>
                            <div class="text-xs text-gray-500">Resolved</div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur"
                >
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">
                        This Week
                    </h3>
                    <div class="flex justify-between">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">
                                {{ performance_metrics.week_created|default:0 }}
                            </div>
                            <div class="text-xs text-gray-500">Created</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">
                                {{ performance_metrics.week_resolved|default:0}}
                            </div>
                            <div class="text-xs text-gray-500">Resolved</div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur"
                >
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">
                        Avg Resolution
                    </h3>
                    <div class="text-2xl font-bold text-purple-600">
                        {% if performance_metrics.avg_resolution_time %} {{ performance_metrics.avg_resolution_time|floatformat:1 }}h {% else %} — {% endif %}
                    </div>
                </div>
                <div
                    class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur"
                >
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">
                        SLA Compliance
                    </h3>
                    <div class="text-2xl font-bold text-emerald-600">
                        {{ performance_metrics.sla_compliance_rate|default:0 }}%
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Analytics Charts -->
        {% if issue_distribution or analytics %}
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Analytics</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                {% if issue_distribution %}
                <div
                    class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur"
                >
                    <h3 class="text-xl font-bold text-gray-700 mb-4">
                        Issue Type Distribution
                    </h3>
                    <canvas id="issueTypeChart" class="w-full h-64"></canvas>
                </div>
                {% endif %}

                <div
                    class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur"
                >
                    <h3 class="text-xl font-bold text-gray-700 mb-4">
                        Priority Distribution
                    </h3>
                    <canvas id="priorityChart" class="w-full h-64"></canvas>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Team Performance (Manager/Admin/HR) -->
        {% if workload_data and user_roles.is_admin or user_roles.is_manager %}
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                Team Performance
            </h2>
            <div class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur">
                <h3 class="text-lg font-bold text-gray-700 mb-4">
                    Workload Distribution
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Team Member</th>
                                <th class="text-left py-3 px-4">
                                    Current Load
                                </th>
                                <th class="text-left py-3 px-4">
                                    Avg Priority
                                </th>
                                <th class="text-left py-3 px-4">Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in workload_data %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">
                                    <div class="flex items-center gap-2">
                                        <div
                                            class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs"
                                        >
                                            {{ member.assigned_to_user__first_name|slice:":1"}}{{ member.assigned_to_user__last_name|slice:":1"  }}
                                        </div>
                                        <span
                                            >{{ member.assigned_to_user__first_name}} {{ member.assigned_to_user__last_name}}</span
                                        >
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <span
                                        class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold"
                                    >
                                        {{ member.ticket_count }} tickets
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <span
                                        class="px-2 py-1 rounded-full {% if member.avg_priority >= 3.5 %}bg-red-100 text-red-700 {% elif member.avg_priority >= 2.5 %}bg-orange-100 text-orange-700 {% elif member.avg_priority >= 1.5 %}bg-yellow-100 text-yellow-700 {% else %}bg-green-100 text-green-700{% endif %} text-xs font-semibold"
                                    >
                                        {{ member.avg_priority|floatformat:1 }}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <div
                                        class="w-full bg-gray-200 rounded-full h-2"
                                    >
                                        <div
                                            class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full"
                                            style="width: 75%"
                                        ></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        {% endif %}
        <!-- Recent Tickets -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
            {% if role_type == 'employee' %}My Recent Tickets{% else %}Recent Tickets{% endif %}
            </h2>
            <div
                class="bg-white/90 rounded-2xl shadow-lg backdrop-blur overflow-hidden"
            >
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr
                                class="bg-gradient-to-r from-blue-50 to-purple-50 border-b"
                            >
                                <th
                                    class="text-left py-4 px-6 font-bold text-gray-700"
                                >
                                    ID
                                </th>
                                <th
                                    class="text-left py-4 px-6 font-bold text-gray-700"
                                >
                                    Subject
                                </th>
                                <th
                                    class="text-left py-4 px-6 font-bold text-gray-700"
                                >
                                    Status
                                </th>
                                <th
                                    class="text-left py-4 px-6 font-bold text-gray-700"
                                >
                                    Priority
                                </th>
                                <th
                                    class="text-left py-4 px-6 font-bold text-gray-700"
                                >
                                    Created
                                </th>
                                {% if role_type != 'employee' %}
                                <th
                                    class="text-left py-4 px-6 font-bold text-gray-700"
                                >
                                    Assignee
                                </th>
                                {% endif %}
                                <th
                                    class="text-left py-4 px-6 font-bold text-gray-700"
                                >
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in recent_tickets|default:recent_my_tickets|default:recent_team_tickets|default:recent_hr_tickets %}
                            <tr
                                class="border-b hover:bg-gray-50/50 transition-colors"
                            >
                                <td class="py-4 px-6">
                                    <span
                                        class="px-2 py-1 rounded bg-blue-100 text-blue-700 font-mono text-xs font-semibold"
                                    >
                                        {{ ticket.ticket_id }}
                                    </span>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="font-semibold text-gray-800">
                                        {{ ticket.subject|truncatechars:50 }}
                                    </div>
                                    {% if ticket.description %}
                                    <div class="text-xs text-gray-500 mt-1">
                                        {{ ticket.description|truncatechars:80 }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="py-4 px-6">
                                    <span
                                        class="px-2 py-1 rounded-full text-xs font-semibold {% if ticket.status == 'New' %}bg-blue-100 text-blue-700 {% elif ticket.status == 'Open' %}bg-yellow-100 text-yellow-700 {% elif ticket.status == 'In Progress' %}bg-orange-100 text-orange-700 {% elif ticket.status == 'Pending User Response' %}bg-purple-100 text-purple-700 {% elif ticket.status == 'Resolved' %}bg-green-100 text-green-700 {% elif ticket.status == 'Closed' %}bg-gray-100 text-gray-700 {% else %}bg-gray-100 text-gray-700{% endif %}"
                                    >
                                        {{ ticket.status }}
                                    </span>
                                </td>
                                <td class="py-4 px-6">
                                    <span
                                        class="px-2 py-1 rounded-full text-xs font-semibold {% if ticket.priority == 'Critical' %}bg-red-100 text-red-700 {% elif ticket.priority == 'High' %}bg-orange-100 text-orange-700 {% elif ticket.priority == 'Medium' %}bg-yellow-100 text-yellow-700 {% elif ticket.priority == 'Low' %}bg-green-100 text-green-700 {% else %}bg-gray-100 text-gray-700{% endif %}"
                                    >
                                        {{ ticket.priority }}
                                    </span>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="text-gray-600">
                                        {{ ticket.created_at|date:"M j, Y" }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ ticket.created_at|time:"g:i A" }}
                                    </div>
                                </td>
                                {% if role_type != 'employee' %}
                                <td class="py-4 px-6">
                                    {% if ticket.assigned_to_user %}
                                    <div class="flex items-center gap-2">
                                        <div
                                            class="w-6 h-6 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs"
                                        >
                                            {{ ticket.assigned_to_user.first_name|slice:":1" }}
                                            {{ticket.assigned_to_user.last_name|slice:":1"}}
                                        </div>
<span class="text-sm text-gray-700">{{ ticket.assigned_to_user.get_full_name|default:ticket.assigned_to_user.username }}</span>
                                        
                                    </div>
                                    {% else %}
                                    <span
                                        class="px-2 py-1 rounded bg-gray-100 text-gray-500 text-xs"
                                        >Unassigned</span
                                    >
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td class="py-4 px-6">
                                    <div class="flex items-center gap-2">
                                        <a
                                            href="{% url 'aps_support:ticket_detail' pk=ticket.pk %}"
                                            class="inline-flex items-center gap-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg text-xs font-semibold transition"
                                        >
                                            <svg
                                                class="w-3 h-3"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                                />
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                                />
                                            </svg>
                                            View
                                        </a>
                                        {% if ticket.status == 'Pending User Response' and ticket.user == current_user %}
                                        <span
                                            class="inline-flex items-center gap-1 bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-xs font-semibold"
                                        >
                                            <svg
                                                class="w-3 h-3"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"
                                                />
                                            </svg>
                                            Response Needed
                                        </span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td
                                    colspan="{% if role_type != 'employee' %}7{% else %}6{% endif %}"
                                    class="py-8 px-6 text-center text-gray-500"
                                >
                                    <div
                                        class="flex flex-col items-center gap-3"
                                    >
                                        <svg
                                            class="w-12 h-12 text-gray-300"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                            />
                                        </svg>
                                        <p class="text-lg font-medium">
                                            No tickets found
                                        </p>
                                        <p class="text-sm">
                                            {% if role_type == 'employee' %}You haven't created any tickets yet.{% else %}No recent tickets to display.{% endif %}
                                        </p>
                                        {% if role_type == 'employee' %}
                                        <a
                                            href="{% url 'aps_support:create_ticket' %}"
                                            class="mt-2 inline-flex items-center gap-2 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-lg transition transform hover:scale-105"
                                        >
                                            <svg
                                                class="w-4 h-4"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                                />
                                            </svg>
                                            Create Your First Ticket
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if recent_tickets|default:recent_my_tickets|default:recent_team_tickets|default:recent_hr_tickets  %}
                <div class="bg-gray-50/50 px-6 py-4 border-t">
                    <div
                        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                    >
                        <div
                            class="flex flex-col sm:flex-row sm:items-center gap-4"
                        >
                            <p class="text-sm text-gray-600">
                                {% if role_type == 'employee' %}
                                Showing your 
                                {{ recent_my_tickets|length|default:0 }} 
                                mostrecent tickets 
                                {% elif role_type == 'admin' %}
                                Showing 
                                {{ recent_tickets|length|default:0 }}
                                recent system tickets 
                                {% elif role_type == 'manager' %} 
                                Showing 
                                {{ recent_team_tickets|length|default:0 }} 
                                recent team tickets 
                                {% elif role_type == 'hr' %}
                                Showing 
                                {{ recent_hr_tickets|length|default:0 }}
                                recent HR tickets 
                                {% else %} 
                                Showing recent tickets 
                                {% endif %}
                            </p>
                            <div class="flex items-center gap-3">
                                <a
                                    href="{% url 'aps_support:ticket_list' %}"
                                    class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium text-sm transition-colors"
                                >
                                    <svg
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                                        />
                                    </svg>
                                    View all tickets
                                </a>
                                {% if role_type == 'employee' %}
                                <a
                                    href="{% url 'aps_support:create_ticket' %}"
                                    class="inline-flex items-center gap-1 text-green-600 hover:text-green-800 font-medium text-sm transition-colors"
                                >
                                    <svg
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                        />
                                    </svg>
                                    Create new ticket
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500"
                                    >Last updated:</span
                                >
                                <span class="text-xs text-gray-700 font-mono"
                                    >{{ "now"|date:"M j, g:i A" }}</span
                                >
                            </div>
                            <div class="flex items-center gap-1">
                                <button
                                    onclick="location.reload()"
                                    class="inline-flex items-center gap-1 text-gray-400 hover:text-gray-600 transition-colors p-1 rounded"
                                    title="Refresh data"
                                >
                                    <svg
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                        />
                                    </svg>
                                </button>
                                {% if user_roles.is_admin or user_roles.is_manager %}
                                <button
                                    onclick="exportTicketsData()"
                                    class="inline-flex items-center gap-1 text-gray-400 hover:text-gray-600 transition-colors p-1 rounded"
                                    title="Export tickets"
                                >
                                    <svg
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                        />
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% if stats %}
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div
                            class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4"
                        >
                            {% if role_type == 'admin' %}
                            <div class="text-center">
                                <div class="text-lg font-bold text-blue-600">
                                    {{ stats.total_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">Total</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600">
                                    {{ stats.open_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">Open</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-red-600">
                                    {{ stats.overdue_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">Overdue</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-gray-600">
                                    {{ stats.unassigned_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Unassigned
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-orange-600">
                                    {{ stats.breached_sla|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    SLA Breached
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-purple-600">
                                    {{ stats.escalated_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Escalated
                                </div>
                            </div>
                            {% elif role_type == 'manager' %}
                            <div class="text-center">
                                <div class="text-lg font-bold text-blue-600">
                                    {{ stats.total_team_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Team Total
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600">
                                    {{ stats.open_team_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Team Open
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-green-600">
                                    {{ stats.my_assignments|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    My Tasks
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-purple-600">
                                    {{ stats.team_members|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Team Size
                                </div>
                            </div>
                            {% elif role_type == 'hr' %}
                            <div class="text-center">
                                <div class="text-lg font-bold text-green-600">
                                    {{ stats.total_hr_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    HR Total
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-blue-600">
                                    {{ stats.access_requests|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Access Requests
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-red-600">
                                    {{ stats.my_assignments|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    My Tasks
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-orange-600">
                                    {{ stats.pending_approval|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">Pending</div>
                            </div>
                            {% else %}
                            <div class="text-center">
                                <div class="text-lg font-bold text-blue-600">
                                    {{ stats.total_my_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    My Total
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600">
                                    {{ stats.open_my_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">Open</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-green-600">
                                    {{ stats.resolved_my_tickets|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Resolved
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-red-600">
                                    {{ stats.pending_response|default:0 }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Need Response
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- Quick Insights Section -->
        {% if recommendations %}
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                Smart Recommendations
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for recommendation in recommendations|slice:":6" %}
                <div
                    class="bg-white/90 rounded-2xl shadow-lg p-6 backdrop-blur border-l-4 {% if recommendation.severity == 'critical' %}border-red-500 {% elif recommendation.severity == 'high' %}border-orange-500 {% elif recommendation.severity == 'medium' %}border-yellow-500 {% else %}border-blue-500{% endif %}"
                >
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-800">
                            {{ recommendation.title }}
                        </h3>
                        <span
                            class="px-2 py-1 rounded-full text-xs font-semibold {% if recommendation.severity == 'critical' %}bg-red-100 text-red-700 {% elif recommendation.severity == 'high' %}bg-orange-100 text-orange-700 {% elif recommendation.severity == 'medium' %}bg-yellow-100 text-yellow-700 {% else %}bg-blue-100 text-blue-700{% endif %}"
                        >
                            {{ recommendation.severity|capfirst }}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">
                        {{ recommendation.description }}
                    </p>
                    {% if recommendation.actions %}
                    <div class="space-y-2">
                        <p
                            class="text-xs font-semibold text-gray-700 uppercase tracking-wide"
                        >
                            Suggested Actions:
                        </p>
                        <ul class="text-xs text-gray-600 space-y-1">
                            {% for action in recommendation.actions|slice:":3" %}
                            <li class="flex items-start gap-2">
                                <svg
                                    class="w-3 h-3 text-green-500 mt-0.5 flex-shrink-0"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                                {{ action }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>
</div>

<!-- JavaScript for Enhanced Functionality -->
<script>
    // Auto-refresh data every 5 minutes
    setInterval(() => {
        // Only refresh if user is active
        if (document.visibilityState === 'visible') {
            fetch('{% url "aps_support:support_analytics_api" %}')
                .then(response => response.json())
                .then(data => {
                    // Update real-time metrics if needed
                    console.log('Dashboard data refreshed:', data);
                })
                .catch(error => console.log('Refresh error:', error));
        }
    }, 300000); // 5 minutes

    // Export functionality
    function exportTicketsData() {
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'csv');
        window.location.href = '{% url "aps_support:ticket_list" %}?' + params.toString();
    }

    // Date range functionality
    document.getElementById('date_range').addEventListener('change', function() {
        const customContainer = document.getElementById('custom-date-container');
        if (this.value === 'custom') {
            customContainer.classList.remove('hidden');
            // Initialize date pickers
            flatpickr('#from_date', {
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });
            flatpickr('#to_date', {
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });
        } else {
            customContainer.classList.add('hidden');
        }
    });

    // Initialize charts if data is available
    {% if issue_distribution %}
    const issueCtx = document.getElementById('issueTypeChart');
    if (issueCtx) {
        new Chart(issueCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for item in issue_distribution %}'{{ item.issue_type }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for item in issue_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    backgroundColor: [
                        '#3B82F6', '#EF4444', '#10B981', '#F59E0B',
                        '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    {% endif %}

    // Initialize feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + R for refresh
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            location.reload();
        }

        // Ctrl/Cmd + N for new ticket (employees only)
        {% if role_type == 'employee' %}
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            window.location.href = '{% url "aps_support:create_ticket" %}';
        }
        {% endif %}
    });
</script>

{% endblock %}
