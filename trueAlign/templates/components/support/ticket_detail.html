{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex items-center space-x-4">
                <a href="{% url 'aps_support:ticket_list' %}" class="inline-flex items-center px-4 py-2.5 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-200 shadow-sm transition-all duration-200 hover:shadow-md">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Tickets
                </a>
                <h1 class="text-3xl font-bold text-gray-900 break-all">Ticket #{{ ticket.ticket_id }}</h1>
            </div>
            <div class="flex items-center space-x-3">
                {% if ticket.status == 'RESOLVED' or ticket.status == 'CLOSED' %}
                    {% if permissions.can_change_status %}
                    <form method="POST" action="{% url 'aps_support:ticket_detail' pk=ticket.pk %}" onsubmit="return confirm('Are you sure you want to reopen this ticket?');">
                        {% csrf_token %}
                        <input type="hidden" name="new_status" value="OPEN">
                        <button type="submit" name="action_update_status" class="inline-flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold bg-amber-50 text-amber-700 border border-amber-200 hover:bg-amber-100 transition-all duration-200 hover:shadow-md">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Reopen Ticket
                        </button>
                    </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 overflow-hidden hover:shadow-xl transition-all duration-300">
                    <div class="p-8 space-y-8">
                        <h2 class="text-2xl font-bold text-gray-800">{{ ticket.subject }}</h2>

                        <div class="flex flex-wrap items-center gap-4">
                            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium border
                                {% if ticket.status == 'NEW' %}bg-blue-50 text-blue-700 border-blue-200
                                {% elif ticket.status == 'OPEN' %}bg-amber-50 text-amber-700 border-amber-200
                                {% elif ticket.status == 'IN_PROGRESS' %}bg-indigo-50 text-indigo-700 border-indigo-200
                                {% elif ticket.status == 'RESOLVED' %}bg-emerald-50 text-emerald-700 border-emerald-200
                                {% elif ticket.status == 'CLOSED' %}bg-gray-50 text-gray-700 border-gray-200
                                {% endif %}">
                                <div class="w-2.5 h-2.5 rounded-full mr-2
                                {% if ticket.status == 'NEW' %}bg-blue-500
                                {% elif ticket.status == 'OPEN' %}bg-amber-500
                                {% elif ticket.status == 'IN_PROGRESS' %}bg-indigo-500
                                {% elif ticket.status == 'RESOLVED' %}bg-emerald-500
                                {% elif ticket.status == 'CLOSED' %}bg-gray-500
                                {% endif %}"></div>
                                {{ ticket.get_status_display }}
                            </span>
                             <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium border
                                {% if ticket.priority == 'LOW' %}bg-green-50 text-green-700 border-green-200
                                {% elif ticket.priority == 'NORMAL' %}bg-blue-50 text-blue-700 border-blue-200
                                {% elif ticket.priority == 'HIGH' %}bg-orange-50 text-orange-700 border-orange-200
                                {% elif ticket.priority == 'URGENT' %}bg-red-50 text-red-700 border-red-200
                                {% endif %}">
                                <div class="w-2.5 h-2.5 rounded-full mr-2
                                {% if ticket.priority == 'LOW' %}bg-green-500
                                {% elif ticket.priority == 'NORMAL' %}bg-blue-500
                                {% elif ticket.priority == 'HIGH' %}bg-orange-500
                                {% elif ticket.priority == 'URGENT' %}bg-red-500
                                {% endif %}"></div>
                                {{ ticket.get_priority_display }}
                            </span>
                            {% if ticket.assigned_group %}
                            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-purple-50 text-purple-700 border border-purple-200">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path></svg>
                                {{ ticket.get_assigned_group_display }}
                            </span>
                            {% endif %}
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Description</h3>
                            <div class="prose max-w-none text-gray-600">
                                {{ ticket.description|linebreaksbr }}
                            </div>
                        </div>

                         {% if ticket.status == 'RESOLVED' or ticket.status == 'CLOSED' %}
                            {% if ticket.resolution_summary %}
                            <div class="pt-6 border-t border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Resolution Summary</h3>
                                <div class="prose max-w-none text-gray-600 bg-emerald-50 border-l-4 border-emerald-400 p-4 rounded-r-lg">
                                    {{ ticket.resolution_summary|linebreaksbr }}
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                {% if permissions.can_comment %}
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 p-8 hover:shadow-xl transition-all duration-300">
                    <form method="POST" action="{% url 'aps_support:ticket_detail' pk=ticket.pk %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Add a Comment</h3>
                        <textarea name="comment_content" rows="4" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Type your comment here..." required></textarea>

                        <div class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                         <div class="flex-grow opacity-50 pointer-events-none">
  <label for="comment_attachments" class="block text-sm font-medium text-gray-700 mb-1">Attach Files</label>
  <input 
    type="file" 
    name="comment_attachments" 
    id="comment_attachments" 
    multiple 
    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
    disabled
  >
  <div id="file-list" class="text-xs text-gray-500 mt-1"></div>
</div>

                            <div class="flex items-center space-x-4">
                                {% if permissions.can_add_internal_comment %}
                                <label class="flex items-center space-x-2 text-sm text-yellow-700">
                                    <input type="checkbox" name="is_internal" class="rounded border-gray-300 text-yellow-600 shadow-sm focus:border-yellow-300 focus:ring focus:ring-offset-0 focus:ring-yellow-200 focus:ring-opacity-50">
                                    <span>Internal Note</span>
                                </label>
                                {% endif %}
                                <button type="submit" name="action_add_comment" class="inline-flex items-center px-6 py-2.5 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg transition">
                                    Submit Comment
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}

   <div class="bg-white backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 overflow-hidden hover:shadow-xl transition-all duration-300">
    <div class="p-8">
        <h3 class="text-lg font-semibold text-gray-700 mb-6">Activity Feed</h3>
        
        <!-- Main scrollable container with improved scrollbar -->
        <div class="space-y-6 overflow-y-auto max-h-[500px] pr-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
            {% for comment in comments %}
            <div class="flex space-x-4">
                  <div class="h-10 w-10 bg-gradient-to-br from-gray-400 to-gray-600 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
                                    <span class="text-white font-semibold text-lg">{{ comment.user.first_name.0|default:comment.user.username.0|upper }}</span>
                                </div>
                                <div class="flex-grow">
                                    <div class="p-4 rounded-lg
                                        {% if comment.is_internal %} bg-yellow-50 border border-yellow-200
                                        {% else %} bg-gray-50 border border-gray-200 {% endif %}">
                                        <div class="flex justify-between items-center mb-2">
                                            <p class="font-semibold text-gray-800">{{ comment.user.get_full_name|default:comment.user.username }}</p>
                                            <p class="text-xs text-gray-500">{{ comment.created_at|date:"M d, Y, g:i A" }}</p>
                                        </div>
                                        <div class="prose max-w-none text-gray-600">
                                            {{ comment.content|linebreaksbr }}
                                        </div>
                                        {% with attachments=comment.attachments.all %}
        {% if attachments %}
          <div class="mt-4 pt-3 border-t border-gray-200/80">
            <p class="text-sm font-semibold text-gray-600 mb-2">Attachments:</p>
            <ul class="space-y-2">
              {% for att in attachments %}
                <li>
                  <a href="{{ att.file.url }}" download class="flex items-center space-x-2 text-blue-600 hover:underline text-sm p-1 rounded-md hover:bg-blue-50 transition-colors">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                    <span class="truncate">{{ att.original_filename }}</span>
                    <span class="text-gray-400 text-xs ml-auto">({{ att.file.size|filesizeformat }})</span>
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      {% endwith %}
                                        {% if comment.is_internal %}
                                        <div class="mt-3 text-xs font-semibold text-yellow-600 flex items-center">
                                            <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 0118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"></path></svg>
                                            Internal Note
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-center text-gray-500 py-4">No comments yet.</p>
                            {% endfor %}

                            {% for activity in activities %}
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <div class="w-10 text-center"><svg class="w-5 h-5 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                                    <div>
                                        <strong>{{ activity.user.get_full_name|default:activity.user.username }}</strong>
                                        {{ activity.get_action_display }}:
                                        <span class="text-gray-700">{{ activity.details }}</span>
                                        <span class="text-xs ml-2">({{ activity.timestamp|date:"M d, Y, g:i A" }})</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Ticket Actions</h3>
                    <div class="space-y-6">
                        {% if permissions.can_change_status %}
                        <form method="POST" action="{% url 'aps_support:ticket_detail' pk=ticket.pk %}">
                            {% csrf_token %}
                            <label for="new_status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select name="new_status" id="new_status" class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" onchange="toggleResolution(this.value)">
                                {% for value, name in status_choices %}
                                <option value="{{ value }}" {% if ticket.status == value %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                            <div id="resolution-section" class="mt-2 hidden">
                                <label for="resolution_summary" class="block text-sm font-medium text-gray-700 mb-1">Resolution Summary</label>
                                <textarea name="resolution_summary" id="resolution_summary" rows="3" class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500"></textarea>
                            </div>
                            <button type="submit" name="action_update_status" class="w-full mt-2 text-center px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition">Update Status</button>
                        </form>
                        {% endif %}

                        {% if permissions.can_assign %}
                        <form method="POST" action="{% url 'aps_support:ticket_detail' pk=ticket.pk %}">
                            {% csrf_token %}
                            <label for="assigned_group" class="block text-sm font-medium text-gray-700 mb-1">Assigned Group</label>
                             <select name="assigned_group" id="assigned_group" class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                                <option value="">---</option>
                                {% for value, name in assigned_group_choices %}
                                <option value="{{ value }}" {% if ticket.assigned_group == value %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                            <label for="assigned_to_user" class="block text-sm font-medium text-gray-700 mt-2 mb-1">Assigned To</label>
                            <select name="assigned_to_user" id="assigned_to_user" class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                                <option value="">Unassigned</option>
                                {% for user in assignable_users %}
                                <option value="{{ user.pk }}" {% if ticket.assigned_to_user.pk == user.pk %}selected{% endif %}>{{ user.get_full_name|default:user.username }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" name="action_assign_ticket" class="w-full mt-2 text-center px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition">Update Assignment</button>
                        </form>
                        {% endif %}

                        {% if permissions.can_edit %}
                        <form method="POST" action="{% url 'aps_support:ticket_detail' pk=ticket.pk %}">
                            {% csrf_token %}
                            <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            <select name="priority" id="priority" class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                                {% for value, name in priority_choices %}
                                <option value="{{ value }}" {% if ticket.priority == value %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" name="action_update_priority" class="w-full mt-2 text-center px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition">Update Priority</button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Details</h3>
                    <div class="space-y-4 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Created by:</span>
                            <span class="font-semibold text-gray-800">{{ ticket.user.get_full_name|default:ticket.user.username }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Created on:</span>
                            <span class="font-semibold text-gray-800">{{ ticket.created_at|date:"M d, Y, g:i A" }}</span>
                        </div>
                         <div class="flex justify-between">
                            <span class="text-gray-500">Last Updated:</span>
                            <span class="font-semibold text-gray-800">{{ ticket.updated_at|date:"M d, Y, g:i A" }}</span>
                        </div>
                        {% if ticket.resolved_at %}
                        <div class="flex justify-between">
                            <span class="text-gray-500">Resolved on:</span>
                            <span class="font-semibold text-gray-800">{{ ticket.resolved_at|date:"M d, Y, g:i A" }}</span>
                        </div>
                         <div class="flex justify-between">
                            <span class="text-gray-500">Resolution Time:</span>
                            <span class="font-semibold text-gray-800">{{ ticket.resolution_time }}</span>
                        </div>
                        {% endif %}

                        {% if permissions.can_edit %}
                        <form method="POST" action="{% url 'aps_support:ticket_detail' pk=ticket.pk %}" class="pt-4 border-t">
                             {% csrf_token %}
                            <label for="due_date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="datetime-local" name="due_date" id="due_date" value="{{ ticket.due_date|date:'Y-m-d\TH:i' }}" class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <button type="submit" name="action_set_due_date" class="w-full mt-2 text-center px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition">Set Due Date</button>
                        </form>
                         {% else %}
                             {% if ticket.due_date %}
                             <div class="flex justify-between pt-2 border-t">
                                 <span class="text-gray-500">Due Date:</span>
                                 <span class="font-semibold text-red-600">{{ ticket.due_date|date:"M d, Y, g:i A" }}</span>
                             </div>
                             {% endif %}
                         {% endif %}

                        <div class="pt-4 border-t">
                            <p class="text-gray-500 mb-2">CC'd Users:</p>
                            <div class="flex flex-wrap gap-2">
                                {% for user in ticket.cc_users.all %}
                                <span class="px-2 py-1 bg-gray-200 text-gray-800 rounded-full text-xs">{{ user.get_full_name|default:user.username }}</span>
                                {% empty %}
                                <p class="text-xs text-gray-400">No users are CC'd.</p>
                                {% endfor %}
                            </div>
                             {% if permissions.can_edit %}
                            <form method="POST" action="{% url 'aps_support:ticket_detail' pk=ticket.pk %}" class="mt-4">
                                 {% csrf_token %}
                                <label for="cc_users" class="block text-sm font-medium text-gray-700 mb-1">Update CC</label>
                                <select name="cc_users" id="cc_users" multiple class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                                    {% for user in all_users %}
                                    <option value="{{ user.pk }}" {% if user in ticket.cc_users.all %}selected{% endif %}>{{ user.get_full_name|default:user.username }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" name="action_add_cc_users" class="w-full mt-2 text-center px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition">Update CC List</button>
                            </form>
                            {% endif %}
                        </div>

                    </div>
                </div>

                {% if attachments %}
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Attachments</h3>
                    <div class="space-y-3">
                        {% for att in attachments %}
                        <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50">
                            <div class="flex items-center space-x-3">
                                <svg class="w-6 h-6 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <a href="{% url 'aps_support:download_attachment' pk=ticket.pk attachment_id=att.pk %}" class="text-sm font-medium text-blue-600 hover:underline truncate" title="{{ att.original_filename }}">
                                    {{ att.formatted_filename|truncatechars:30 }}
                                </a>
                            </div>
                            <span class="text-xs text-gray-400">{{ att.file_size|filesizeformat }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    function toggleResolution(status) {
        const resolutionSection = document.getElementById('resolution-section');
        if (status === 'Resolved') {
            resolutionSection.classList.remove('hidden');
            document.getElementById('resolution_summary').required = true;
        } else {
            resolutionSection.classList.add('hidden');
            document.getElementById('resolution_summary').required = false;
        }
    }

    function updateFileList(input, listId) {
        const fileList = document.getElementById(listId);
        if (input.files.length > 0) {
            let filesText = Array.from(input.files).map(f => f.name).join(', ');
            fileList.textContent = `Selected: ${filesText}`;
        } else {
            fileList.textContent = '';
        }
    }

    // Initialize the resolution field on page load if status is already 'RESOLVED'
    document.addEventListener('DOMContentLoaded', function() {
        const statusSelect = document.getElementById('new_status');
        if (statusSelect) {
            toggleResolution(statusSelect.value);
        }
    });
</script>
{% endblock %}