{% extends 'base.html' %} {% block content %}
<div
    class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 py-8"
>
    <input type="hidden" name="ticket_id" value="{{ ticket.id }}" />
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div
            class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
        >
            <div class="flex items-center space-x-4">
                <a
                    href="{% url 'aps_support:ticket_list' %}"
                    class="inline-flex items-center px-4 py-2.5 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-200 shadow-sm transition-all duration-200 hover:shadow-md"
                >
                    <svg
                        class="w-5 h-5 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"
                        />
                    </svg>
                    Back to Tickets
                </a>
                <h1 class="text-3xl font-bold text-gray-900">
                    Ticket #{{ ticket.ticket_id }}
                </h1>
            </div>

            <div class="flex items-center space-x-3">
                {% if ticket.status == 'resolved' or ticket.status == 'closed' %} {% if can_reopen %}
                <button
                    onclick="confirmReopen()"
                    class="inline-flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold bg-amber-50 text-amber-700 border border-amber-200 hover:bg-amber-100 transition-all duration-200 hover:shadow-md"
                >
                    <svg
                        class="w-4 h-4 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        />
                    </svg>
                    Reopen Ticket
                </button>
                {% endif %} {% endif %} {% if can_escalate and ticket.status != 'closed' %}
                <button
                    onclick="confirmEscalate()"
                    class="inline-flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold bg-red-50 text-red-700 border border-red-200 hover:bg-red-100 transition-all duration-200 hover:shadow-md"
                >
                    <svg
                        class="w-4 h-4 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                        />
                    </svg>
                    Escalate (Level {{ ticket.escalation_level|add:"1" }})
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Ticket Info -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Ticket Info Card -->
                <div
                    class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 overflow-hidden hover:shadow-xl transition-all duration-300"
                >
                    <div class="p-8 space-y-8">
                        <!-- Status & Priority Row -->
                        <div class="flex flex-wrap items-center gap-4">
                            <span
                                class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium border {% if ticket.status == 'new' %}bg-blue-50 text-blue-700 border-blue-200 {% elif ticket.status == 'open' %}bg-amber-50 text-amber-700 border-amber-200 {% elif ticket.status == 'in_progress' %}bg-indigo-50 text-indigo-700 border-indigo-200 {% elif ticket.status == 'resolved' %}bg-emerald-50 text-emerald-700 border-emerald-200 {% elif ticket.status == 'closed' %}bg-gray-50 text-gray-700 border-gray-200 {% endif %}"
                            >
                                <div
                                    class="w-2.5 h-2.5 rounded-full mr-2 {% if ticket.status == 'new' %}bg-blue-500 {% elif ticket.status == 'open' %}bg-amber-500 {% elif ticket.status == 'in_progress' %}bg-indigo-500 {% elif ticket.status == 'resolved' %}bg-emerald-500 {% elif ticket.status == 'closed' %}bg-gray-500 {% endif %}"
                                ></div>
                                {{ ticket.get_status_display }}
                            </span>

                            <span
                                class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium border {% if ticket.priority == 'low' %}bg-green-50 text-green-700 border-green-200 {% elif ticket.priority == 'normal' %}bg-blue-50 text-blue-700 border-blue-200 {% elif ticket.priority == 'high' %}bg-orange-50 text-orange-700 border-orange-200 {% elif ticket.priority == 'urgent' %}bg-red-50 text-red-700 border-red-200 {% endif %}"
                            >
                                <div
                                    class="w-2.5 h-2.5 rounded-full mr-2 {% if ticket.priority == 'low' %}bg-green-500 {% elif ticket.priority == 'normal' %}bg-blue-500 {% elif ticket.priority == 'high' %}bg-orange-500 {% elif ticket.priority == 'urgent' %}bg-red-500 {% endif %}"
                                ></div>
                                {{ ticket.get_priority_display }}
                            </span>

                            {% if ticket.assigned_group %}
                            <span
                                class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-purple-50 text-purple-700 border border-purple-200"
                            >
                                <svg
                                    class="w-4 h-4 mr-2"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"
                                    ></path>
                                </svg>
                                {{ ticket.get_assigned_group_display }}
                            </span>
                            {% endif %} {% if sla_info %}
                            <span
                                class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium border {% if sla_info.status == 'breached' %}bg-red-50 text-red-700 border-red-200 {% elif sla_info.status == 'at risk' %}bg-yellow-50 text-yellow-700 border-yellow-200 {% else %}bg-green-50 text-green-700 border-green-200{% endif %}"
                            >
                                <svg
                                    class="w-4 h-4 mr-2"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                                {{ sla_info.status|title }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Ticket Details Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Created Info -->
                            <div
                                class="flex items-center space-x-4 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100"
                            >
                                <div
                                    class="h-12 w-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center shadow-md"
                                >
                                    <span
                                        class="text-white font-semibold text-lg"
                                    >
                                        {{ ticket.user.first_name.0|default:ticket.user.username.0|upper }}
                                    </span>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-gray-500"
                                    >
                                        Created by
                                    </p>
                                    <p
                                        class="text-lg font-semibold text-gray-900"
                                    >
                                        {{ ticket.user.get_full_name|default:ticket.user.username }}
                                    </p>
                                </div>
                            </div>

                            <!-- Created Date -->
                            <div
                                class="flex items-center space-x-4 p-5 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100"
                            >
                                <div
                                    class="h-12 w-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center shadow-md"
                                >
                                    <svg
                                        class="w-6 h-6 text-white"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                        ></path>
                                    </svg>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-gray-500"
                                    >
                                        Created on
                                    </p>
                                    <p
                                        class="text-lg font-semibold text-gray-900"
                                    >
                                        {{ ticket.created_at|date:"M d, Y g:i A" }}
                                    </p>
                                </div>
                            </div>

                            <!-- Assigned To -->
                            {% if ticket.assigned_to_user %}
                            <div
                                class="flex items-center space-x-4 p-5 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-100"
                            >
                                <div
                                    class="h-12 w-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full flex items-center justify-center shadow-md"
                                >
                                    <span
                                        class="text-white font-semibold text-lg"
                                    >
                                        {{ ticket.assigned_to_user.first_name.0|default:ticket.assigned_to_user.username.0|upper }}
                                    </span>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-gray-500"
                                    >
                                        Assigned to
                                    </p>
                                    <p
                                        class="text-lg font-semibold text-gray-900"
                                    >
                                        {{ ticket.assigned_to_user.get_full_name|default:ticket.assigned_to_user.username }}
                                    </p>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Due Date -->
                            {% if ticket.due_date %}
                            <div
                                class="flex items-center space-x-4 p-5 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-100"
                            >
                                <div
                                    class="h-12 w-12 bg-gradient-to-br from-amber-400 to-amber-600 rounded-full flex items-center justify-center shadow-md"
                                >
                                    <svg
                                        class="w-6 h-6 text-white"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                        ></path>
                                    </svg>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-medium text-gray-500"
                                    >
                                        Due Date
                                    </p>
                                    <p
                                        class="text-lg font-semibold text-gray-900"
                                    >
                                        {{ ticket.due_date|date:"M d, Y g:i A" }}
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-gray-900">
                                Description
                            </h3>
                            <div
                                class="prose max-w-none p-6 bg-gray-50 rounded-xl border border-gray-200"
                            >
                                {{ ticket.description|linebreaks }}
                            </div>
                        </div>

                        <!-- CC Users -->
                        {% if ticket.cc_users.exists %}
                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-gray-900">
                                CC Users
                            </h3>
                            <div class="flex flex-wrap gap-3">
                                {% for cc_user in ticket.cc_users.all %}
                                <span
                                    class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-blue-50 text-blue-700 border border-blue-200"
                                >
                                    <span
                                        class="w-7 h-7 rounded-full bg-blue-200 flex items-center justify-center mr-3 text-xs font-semibold"
                                    >
                                        {{ cc_user.first_name.0|default:cc_user.username.0|upper }}
                                    </span>
                                    {{ cc_user.get_full_name|default:cc_user.username }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Comments and Activities -->
                <div
                    class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 overflow-hidden hover:shadow-xl transition-all duration-300"
                >
                    <div
                        class="border-b border-gray-100 px-8 py-6 bg-gradient-to-r from-green-50 to-teal-50"
                    >
                        <h3
                            class="text-2xl font-bold text-gray-900 flex items-center"
                        >
                            <svg
                                class="w-7 h-7 mr-3 text-green-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2v-6a2 2 0 012-2h8z"
                                ></path>
                            </svg>
                            Comments & Activities
                        </h3>
                    </div>

                    <div class="p-8">
                        {% if comments or activities %}
                        <div class="space-y-6">
                            <!-- Display Comments -->
                            {% for comment in comments %}
                            <div
                                class="flex space-x-4 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200/60 hover:shadow-md transition-all duration-300"
                            >
                                <div class="flex-shrink-0">
                                    <div
                                        class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center shadow-lg"
                                    >
                                        <span class="text-white font-semibold">
                                            {{ comment.user.first_name.0|default:comment.user.username.0|upper }}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div
                                        class="flex items-center justify-between mb-3"
                                    >
                                        <p
                                            class="text-lg font-semibold text-gray-900"
                                        >
                                            {{ comment.user.get_full_name|default:comment.user.username }}
                                        </p>
                                        <div
                                            class="flex items-center space-x-3"
                                        >
                                            {% if comment.is_internal %}
                                            <span
                                                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200"
                                            >
                                                <svg
                                                    class="w-3 h-3 mr-1"
                                                    fill="currentColor"
                                                    viewBox="0 0 20 20"
                                                >
                                                    <path
                                                        fill-rule="evenodd"
                                                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                                        clip-rule="evenodd"
                                                    ></path>
                                                </svg>
                                                Internal
                                            </span>
                                            {% endif %}
                                            <p
                                                class="text-sm text-gray-500 font-medium"
                                            >
                                                {{ comment.created_at|date:"M d, Y g:i A" }}
                                            </p>
                                        </div>
                                    </div>

                                    <div
                                        class="p-5 bg-white rounded-xl border border-gray-200 prose max-w-none shadow-sm"
                                    >
                                        {{ comment.content|linebreaks }}
                                    </div>

                                    <!-- Comment Attachments -->
                                    {% if comment.attachments.exists %}
                                    <div class="mt-5">
                                        <h5
                                            class="text-sm font-semibold text-gray-700 mb-3"
                                        >
                                            Attachments:
                                        </h5>
                                        <div
                                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"
                                        >
                                            {% for attachment in comment.attachments.all %}
                                            <div
                                                class="flex items-center space-x-3 p-4 bg-white rounded-xl border border-gray-200 hover:bg-gray-50 transition-all duration-200 shadow-sm"
                                            >
                                                <div class="flex-shrink-0">
                                                    {% if attachment.is_image %}
                                                    <svg
                                                        class="w-6 h-6 text-green-500"
                                                        fill="currentColor"
                                                        viewBox="0 0 20 20"
                                                    >
                                                        <path
                                                            fill-rule="evenodd"
                                                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                                                            clip-rule="evenodd"
                                                        ></path>
                                                    </svg>
                                                    {% else %}
                                                    <svg
                                                        class="w-6 h-6 text-blue-500"
                                                        fill="currentColor"
                                                        viewBox="0 0 20 20"
                                                    >
                                                        <path
                                                            fill-rule="evenodd"
                                                            d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                                                            clip-rule="evenodd"
                                                        ></path>
                                                    </svg>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p
                                                        class="text-sm font-medium text-gray-900 truncate"
                                                    >
                                                        {{ attachment.formatted_filename }}
                                                    </p>
                                                    <p
                                                        class="text-xs text-gray-500"
                                                    >
                                                        {% if attachment.file_size %}
                                                        {{ attachment.file_size|filesizeformat }}{% endif %}
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <a
                                                        href="{{ attachment.file.url }}"
                                                        download
                                                        class="text-blue-600 hover:text-blue-800 transition-colors duration-200"
                                                    >
                                                        <svg
                                                            class="w-5 h-5"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            viewBox="0 0 24 24"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                                            ></path>
                                                        </svg>
                                                    </a>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}

                            <!-- Display Activities -->
                            {% for activity in activities %}
                            <div
                                class="flex space-x-4 p-6 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200/60 hover:shadow-md transition-all duration-300"
                            >
                                <div class="flex-shrink-0">
                                    <div
                                        class="w-12 h-12 bg-gradient-to-br from-gray-400 to-gray-600 rounded-full flex items-center justify-center shadow-lg"
                                    >
                                        <span class="text-white font-semibold">
                                            {{ activity.user.first_name.0|default:activity.user.username.0|upper }}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div
                                        class="flex items-center justify-between mb-3"
                                    >
                                        <p
                                            class="text-lg font-semibold text-gray-900"
                                        >
                                            {{ activity.user.get_full_name|default:activity.user.username }}
                                        </p>
                                        <p
                                            class="text-sm text-gray-500 font-medium"
                                        >
                                            {{ activity.timestamp|date:"M d, Y g:i A" }}
                                        </p>
                                    </div>

                                    {% if activity.action == 'commented' %}
                                    <div
                                        class="p-5 bg-white rounded-xl border border-gray-200 prose max-w-none shadow-sm"
                                    >
                                        {{ activity.details|linebreaks }}
                                    </div>
                                    {% else %}
                                    <p class="text-sm text-gray-600">
                                        <span
                                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-2"
                                        >
                                            {{ activity.get_action_display }}
                                        </span>
                                        {{ activity.details }}
                                    </p>
                                    {% endif %}

                                    <!-- Attachments for this activity -->
                                    {% if activity.comment_attachments.exists %}
                                    <div class="mt-5">
                                        <h5
                                            class="text-sm font-semibold text-gray-700 mb-3"
                                        >
                                            Attachments:
                                        </h5>
                                        <div
                                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"
                                        >
                                            {% for attachment in activity.comment_attachments.all %}
                                            <div
                                                class="flex items-center space-x-3 p-4 bg-white rounded-xl border border-gray-200 hover:bg-gray-50 transition-all duration-200 shadow-sm"
                                            >
                                                <div class="flex-shrink-0">
                                                    {% if attachment.is_image %}
                                                    <svg
                                                        class="w-6 h-6 text-green-500"
                                                        fill="currentColor"
                                                        viewBox="0 0 20 20"
                                                    >
                                                        <path
                                                            fill-rule="evenodd"
                                                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                                                            clip-rule="evenodd"
                                                        ></path>
                                                    </svg>
                                                    {% else %}
                                                    <svg
                                                        class="w-6 h-6 text-blue-500"
                                                        fill="currentColor"
                                                        viewBox="0 0 20 20"
                                                    >
                                                        <path
                                                            fill-rule="evenodd"
                                                            d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                                                            clip-rule="evenodd"
                                                        ></path>
                                                    </svg>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p
                                                        class="text-sm font-medium text-gray-900 truncate"
                                                    >
                                                        {{ attachment.original_filename }}
                                                    </p>
                                                    <p
                                                        class="text-xs text-gray-500"
                                                    >
                                                        {% if attachment.file_size %}
                                                        {{ attachment.file_size|filesizeformat }}{% endif %}
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <a
                                                        href="{{ attachment.file.url }}"
                                                        download
                                                        class="text-blue-600 hover:text-blue-800 transition-colors duration-200"
                                                    >
                                                        <svg
                                                            class="w-5 h-5"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            viewBox="0 0 24 24"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                                            ></path>
                                                        </svg>
                                                    </a>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-16">
                            <div
                                class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"
                            >
                                <svg
                                    class="w-8 h-8 text-gray-400"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                                    ></path>
                                </svg>
                            </div>
                            <h3
                                class="text-lg font-semibold text-gray-900 mb-2"
                            >
                                No comments yet
                            </h3>
                            <p class="text-gray-500">
                                Be the first to add a comment to this ticket.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Right Column - Actions Sidebar -->
            <div class="lg:col-span-1">
                <div
                    class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-white/60 overflow-hidden hover:shadow-xl transition-all duration-300 sticky top-6"
                >
                    <div class="p-6 space-y-6">
                        <!-- Action Tabs -->
                        <div id="actionTabs">
                            <!-- Tab Buttons -->
                            <div class="flex flex-col space-y-2">
                                {% if can_comment %}
                                <button
                                    onclick="switchTab('comment')"
                                    id="tab-comment"
                                    class="tab-button flex items-center space-x-2 w-full px-4 py-3 rounded-lg border transition-all duration-200 bg-blue-50 text-blue-700 border-blue-200"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                                        />
                                    </svg>
                                    <span>Add Comment</span>
                                </button>
                                {% endif %} {% if can_change_status %}
                                <button
                                    onclick="switchTab('status')"
                                    id="tab-status"
                                    class="tab-button flex items-center space-x-2 w-full px-4 py-3 rounded-lg border transition-all duration-200 bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                        />
                                    </svg>
                                    <span>Update Status</span>
                                </button>
                                {% endif %} {% if can_assign %}
                                <button
                                    onclick="switchTab('assign')"
                                    id="tab-assign"
                                    class="tab-button flex items-center space-x-2 w-full px-4 py-3 rounded-lg border transition-all duration-200 bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                    >
                                        <path
                                            d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"
                                        />
                                    </svg>
                                    <span>Assignment</span>
                                </button>
                                {% endif %} {% if can_edit %}
                                <button
                                    onclick="switchTab('other')"
                                    id="tab-other"
                                    class="tab-button flex items-center space-x-2 w-full px-4 py-3 rounded-lg border transition-all duration-200 bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                                        />
                                    </svg>
                                    <span>Other Actions</span>
                                </button>
                                {% endif %}
                            </div>

                            <!-- Tab Panels -->
                            <div class="mt-6">
                                <!-- Add Comment Tab -->
                                {% if can_comment %}
                                <div
                                    id="panel-comment"
                                    class="tab-panel space-y-4"
                                    style="display: block;"
                                >
                                    <form
                                        name="comment-form"
                                        method="post"
                                        enctype="multipart/form-data"
                                        class="space-y-4"
                                    >
                                        {% csrf_token %} {% if can_add_internal_comment %}
                                        <div
                                            class="relative flex items-start"
                                        >
                                            <div
                                                class="flex items-center h-5"
                                            >
                                                <input
                                                    id="is_internal"
                                                    name="is_internal"
                                                    type="checkbox"
                                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                />
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label
                                                    for="is_internal"
                                                    class="font-medium text-gray-700"
                                                    >Internal
                                                    Comment</label
                                                >
                                                <p
                                                    class="text-gray-500"
                                                >
                                                    This comment will
                                                    only be visible to
                                                    staff members.
                                                </p>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <div>
                                            <label
                                                for="comment"
                                                class="block text-sm font-medium text-gray-700"
                                                >Comment</label
                                            >
                                            <div class="mt-1">
                                                <textarea
                                                    id="comment"
                                                    name="comment"
                                                    rows="4"
                                                    required
                                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                                    placeholder="Add your comment here..."
                                                ></textarea>
                                            </div>
                                        </div>

                                        <!-- File Upload Section -->
                                        <div class="mt-4">
                                            <div
                                                id="dropZone"
                                                class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed rounded-md border-gray-300"
                                            >
                                                <div
                                                    class="space-y-1 text-center"
                                                >
                                                    <svg
                                                        class="mx-auto h-12 w-12 text-gray-400"
                                                        stroke="currentColor"
                                                        fill="none"
                                                        viewBox="0 0 48 48"
                                                    >
                                                        <path
                                                            d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                                            stroke-width="2"
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                        />
                                                    </svg>

                                                    <div
                                                        class="flex text-sm text-gray-600"
                                                    >
                                                        <label
                                                            class="relative cursor-pointer rounded-md bg-white font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500"
                                                        >
                                                            <span
                                                                >Upload
                                                                a
                                                                file</span
                                                            >
                                                            <input
                                                                type="file"
                                                                name="attachments"
                                                                id="fileInput"
                                                                class="sr-only"
                                                                multiple
                                                            />
                                                        </label>
                                                        <p class="pl-1">
                                                            or drag and
                                                            drop
                                                        </p>
                                                    </div>
                                                    <p
                                                        class="text-xs text-gray-500"
                                                    >
                                                        PNG, JPG, PDF up
                                                        to 10MB each
                                                    </p>
                                                </div>
                                            </div>

                                            <!-- File Preview -->
                                            <div
                                                id="filePreview"
                                                class="mt-4 space-y-2"
                                                style="display: none;"
                                            >
                                            </div>
                                        </div>

                                        <div class="flex justify-end">
                                            <button
                                                type="submit"
                                                name="add_comment"
                                                id="submitCommentBtn"
                                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
                                            >
                                                <svg
                                                    id="loadingSpinner"
                                                    class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    style="display: none;"
                                                >
                                                    <circle
                                                        class="opacity-25"
                                                        cx="12"
                                                        cy="12"
                                                        r="10"
                                                        stroke="currentColor"
                                                        stroke-width="4"
                                                    ></circle>
                                                    <path
                                                        class="opacity-75"
                                                        fill="currentColor"
                                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                                    ></path>
                                                </svg>
                                                <span id="submitBtnText">Add Comment</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                {% endif %}
                                        <!-- Update Status Tab -->
                                        {% if can_change_status %}
                                        <div
                                            id="panel-status"
                                            class="tab-panel space-y-4"
                                            style="display: none;"
                                        >
                                            <div
                                                class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 border border-yellow-200/50"
                                            >
                                                <form
                                                    method="post"
                                                    id="status-form"
                                                    class="space-y-6"
                                                >
                                                    {% csrf_token %}
                                                    <div>
                                                        <label
                                                            for="new_status"
                                                            class="block text-sm font-semibold text-gray-700 mb-2"
                                                            >New Status</label
                                                        >
                                                        <select
                                                            name="new_status"
                                                            id="new_status"
                                                            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 transition-all duration-200"
                                                        >
                                                            {% for status_value, status_label in status_choices %}
                                                            <option
                                                                value="{{ status_value }}"
                                                                {% if status_value == ticket.status %}selected{% endif %}
                                                            >
                                                                {{ status_label }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div
                                                        id="resolution-summary-container"
                                                        class="hidden"
                                                    >
                                                        <label
                                                            for="resolution_summary"
                                                            class="block text-sm font-semibold text-gray-700 mb-2"
                                                        >
                                                            Resolution Summary
                                                            <span
                                                                class="text-red-500"
                                                                >*</span
                                                            >
                                                        </label>
                                                        <textarea
                                                            name="resolution_summary"
                                                            id="resolution_summary"
                                                            rows="4"
                                                            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 transition-all duration-200"
                                                            placeholder="Please provide a summary of how this ticket was resolved..."
                                                        ></textarea>
                                                        <p
                                                            id="resolution-error"
                                                            class="mt-1 text-sm text-red-600 hidden"
                                                        >
                                                            Resolution summary
                                                            is required when
                                                            resolving or closing
                                                            a ticket.
                                                        </p>
                                                    </div>

                                                    <div
                                                        class="flex justify-end"
                                                    >
                                                        <button
                                                            type="submit"
                                                            name="action_update_status"
                                                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-all duration-200"
                                                        >
                                                            <svg
                                                                class="w-5 h-5 mr-2"
                                                                fill="none"
                                                                stroke="currentColor"
                                                                viewBox="0 0 24 24"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                                />
                                                            </svg>
                                                            Update Status
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Assignment Tab -->
                                        {% if can_assign %}
                                        <div
                                            id="panel-assign"
                                            class="tab-panel space-y-4"
                                            style="display: none;"
                                        >
                                            <div
                                                class="bg-gradient-to-br from-green-50 to-teal-50 rounded-xl p-6 border border-green-200/50"
                                            >
                                                <form
                                                    method="post"
                                                    id="assignment-form"
                                                    class="space-y-6"
                                                >
                                                    {% csrf_token %}
                                                    <div>
                                                        <label
                                                            for="assigned_group"
                                                            class="block text-sm font-semibold text-gray-700 mb-2"
                                                            >Assign to
                                                            Group</label
                                                        >
                                                        <select
                                                            name="assigned_group"
                                                            id="assigned_group"
                                                            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 transition-all duration-200"
                                                        >
                                                            <option value="">
                                                                Select Group
                                                            </option>
                                                            {% for group_value, group_label in group_choices %}
                                                            <option
                                                                value="{{ group_value }}"
                                                                {% if group_value == ticket.assigned_group %}selected{% endif %}
                                                            >
                                                                {{ group_label }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div>
                                                        <label
                                                            for="assigned_to_user"
                                                            class="block text-sm font-semibold text-gray-700 mb-2"
                                                            >Assign to
                                                            User</label
                                                        >
                                                        <select
                                                            name="assigned_to_user"
                                                            id="assigned_to_user"
                                                            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 transition-all duration-200"
                                                        >
                                                            <option value="">
                                                                Select User
                                                            </option>
                                                            {% if ticket.assigned_to_user %}
                                                            <option
                                                                value="{{ ticket.assigned_to_user.id }}"
                                                                selected
                                                            >
                                                                {{ ticket.assigned_to_user.get_full_name|default:ticket.assigned_to_user.username }}
                                                            </option>
                                                            {% endif %}
                                                        </select>
                                                    </div>

                                                    <div
                                                        class="flex justify-end"
                                                    >
                                                        <button
                                                            type="submit"
                                                            name="action_assign_ticket"
                                                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200"
                                                        >
                                                            <svg
                                                                class="w-5 h-5 mr-2"
                                                                fill="none"
                                                                stroke="currentColor"
                                                                viewBox="0 0 24 24"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                                                ></path>
                                                            </svg>
                                                            Assign Ticket
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Other Actions Tab -->
                                        {% if can_edit %}
                                        <div
                                            id="panel-other"
                                            class="tab-panel space-y-4"
                                            style="display: none;"
                                        >
                                            <div
                                                class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-200/50"
                                            >
                                                <div class="space-y-6">
                                                    <!-- CC Users -->
                                                    <form
                                                        method="post"
                                                        class="space-y-4"
                                                    >
                                                        {% csrf_token %}
                                                        <div>
                                                            <label
                                                                for="cc_users"
                                                                class="block text-sm font-semibold text-gray-700 mb-2"
                                                                >CC Users</label
                                                            >
                                                            <select
                                                                class="w-full rounded-xl border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 transition-all duration-200"
                                                                id="cc_users"
                                                                name="cc_users"
                                                                multiple
                                                                size="5"
                                                            >
                                                                {% for user in all_users %}
                                                                <option
                                                                    value="{{ user.pk }}"
                                                                    {% if user in ticket.cc_users.all %}selected{% endif %}
                                                                >
                                                                    {{ user.get_full_name|default:user.username }}
                                                                </option>
                                                                {% endfor %}
                                                            </select>
                                                            <p
                                                                class="mt-1 text-sm text-gray-500"
                                                            >
                                                                Hold Ctrl/Cmd to
                                                                select multiple
                                                                users
                                                            </p>
                                                        </div>
                                                        <div
                                                            class="flex justify-end"
                                                        >
                                                            <button
                                                                type="submit"
                                                                name="add_cc_users"
                                                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200"
                                                            >
                                                                Update CC Users
                                                            </button>
                                                        </div>
                                                    </form>

                                                    <hr
                                                        class="border-purple-200"
                                                    />

                                                    <!-- Due Date -->
                                                    <form
                                                        method="post"
                                                        class="space-y-4"
                                                    >
                                                        {% csrf_token %}
                                                        <div>
                                                            <label
                                                                for="due_date"
                                                                class="block text-sm font-semibold text-gray-700 mb-2"
                                                                >Due Date</label
                                                            >
                                                            <input
                                                                type="datetime-local"
                                                                class="w-full rounded-xl border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 transition-all duration-200"
                                                                id="due_date"
                                                                name="due_date"
                                                                value="{% if ticket.due_date %}{{ ticket.due_date|date:'Y-m-d\TH:i' }}{% endif %}"
                                                            />
                                                        </div>
                                                        <div
                                                            class="flex justify-end"
                                                        >
                                                            <button
                                                                type="submit"
                                                                name="update_due_date"
                                                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200"
                                                            >
                                                                Update Due Date
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket Attachments -->
                {% if attachments %}
                <div
                    class="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 overflow-hidden mb-8 hover:shadow-2xl transition-all duration-300"
                >
                    <div
                        class="border-b border-gray-100/50 px-8 py-6 bg-gradient-to-r from-orange-600/5 to-red-600/5"
                    >
                        <h3
                            class="text-xl font-bold text-gray-900 flex items-center"
                        >
                            <svg
                                class="w-6 h-6 mr-3 text-orange-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
                                ></path>
                            </svg>
                            Ticket Attachments
                        </h3>
                    </div>

                    <div class="p-8">
                        <div
                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
                        >
                            {% for attachment in attachments %}
                            <div
                                class="flex items-center space-x-4 p-4 bg-gradient-to-r from-gray-50 to-gray-100/50 rounded-xl border border-gray-200/50 hover:shadow-md transition-all duration-200"
                            >
                                <div class="flex-shrink-0">
                                    {% if attachment.is_image %}
                                    <svg
                                        class="w-8 h-8 text-green-500"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                                            clip-rule="evenodd"
                                        ></path>
                                    </svg>
                                    {% else %}
                                    <svg
                                        class="w-8 h-8 text-blue-500"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                                            clip-rule="evenodd"
                                        ></path>
                                    </svg>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p
                                        class="text-sm font-medium text-gray-900 truncate"
                                    >
                                        {{ attachment.formatted_filename }}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        {% if attachment.file_size %}{{ attachment.file_size|filesizeformat }}{% endif %} {% if attachment.uploaded_by %}
                                        • {{ attachment.uploaded_by.get_full_name|default:attachment.uploaded_by.username }}{% endif %}
                                    </p>
                                </div>
                                <div class="flex-shrink-0 flex space-x-2">
                                    {% if attachment.is_image %}
                                    <button
                                        type="button"
                                        class="text-blue-600 hover:text-blue-800 transition-colors duration-200"
                                        onclick="showFilePreview('{{ attachment.file.url }}')"
                                    >
                                        <svg
                                            class="w-5 h-5"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                            ></path>
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                            ></path>
                                        </svg>
                                    </button>
                                    {% endif %}
                                    <a
                                        href="{{ attachment.file.url }}"
                                        download="{{ attachment.original_filename }}"
                                        class="text-green-600 hover:text-green-800 transition-colors duration-200"
                                    >
                                        <svg
                                            class="w-5 h-5"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                            ></path>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Loading Overlay -->
        <div
            id="loadingOverlay"
            class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50"
            style="display: none;"
        >
            <div class="bg-white rounded-lg p-6 shadow-xl">
                <div class="flex items-center space-x-4">
                    <svg
                        class="animate-spin h-8 w-8 text-indigo-600"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                        ></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                    </svg>
                    <span class="text-lg font-medium text-gray-900"
                        >Processing...</span
                    >
                </div>
            </div>
        </div>

        <!-- File Preview -->
        <div
            id="filePreviewModal"
            class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm flex items-center justify-center z-50"
            style="display: none;"
            onclick="closePreview()"
        >
            <div class="max-w-4xl mx-auto p-4">
                <img
                    id="previewImage"
                    class="max-h-[80vh] rounded-lg shadow-2xl"
                />
            </div>
        </div>

        <!-- Error Notifications -->
        <div
            id="errorNotifications"
            class="fixed bottom-4 right-4 max-w-sm bg-red-50 border border-red-200 rounded-lg shadow-lg p-4 z-50"
            style="display: none;"
        >
            <div id="errorContent" class="flex items-start space-x-2 text-red-700">
                <svg
                    class="w-5 h-5 flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
                <span id="errorMessage"></span>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentUser = "initator16";
    let currentDateTime = "2025-06-08 13:01:04";
    let ticket_id = "";
    let activeTab = "comment";
    let loading = false;
    let fileDropActive = false;
    let files = [];
    let selectedImage = null;
    let formErrors = {};

    document.addEventListener("DOMContentLoaded", function() {
        // Get ticket ID from the page
        const ticketIdInput = document.querySelector('[name="ticket_id"]');
        ticket_id = ticketIdInput ? ticketIdInput.value : "";

        setupFileUpload();
        setupFormHandlers();
        initializeStatusForm();

        // Initialize tabs based on URL hash if present
        const hash = window.location.hash;
        if (hash) {
            const tab = hash.replace("#", "");
            if (["comment", "status", "assign", "other"].includes(tab)) {
                activeTab = tab;
                switchTab(tab);
            }
        }
    });

    function switchTab(tabName) {
        activeTab = tabName;

        // Hide all panels
        const panels = document.querySelectorAll('.tab-panel');
        panels.forEach(panel => panel.style.display = 'none');

        // Remove active styles from all buttons
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(button => {
            button.className = button.className.replace(/bg-\w+-\d+|text-\w+-\d+|border-\w+-\d+/g, '');
            button.className += ' bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100';
        });

        // Show selected panel
        const selectedPanel = document.getElementById(`panel-${tabName}`);
        if (selectedPanel) {
            selectedPanel.style.display = 'block';
        }

        // Add active styles to selected button
        const selectedButton = document.getElementById(`tab-${tabName}`);
        if (selectedButton) {
            selectedButton.className = selectedButton.className.replace(/bg-\w+-\d+|text-\w+-\d+|border-\w+-\d+/g, '');
            selectedButton.className += ' bg-blue-50 text-blue-700 border-blue-200';
        }

        // Update URL hash without triggering a page reload
        window.history.replaceState(null, null, `#${tabName}`);
    }

    function setupFileUpload() {
        const dropZone = document.getElementById('dropZone');
        if (!dropZone) return;

        ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
            dropZone.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        dropZone.addEventListener("drop", function(e) {
            handleFiles(e.dataTransfer.files);
        });
    }

    function handleFiles(fileList) {
        const validFiles = Array.from(fileList).filter(file => {
            const validTypes = [
                "image/jpeg",
                "image/png",
                "application/pdf",
                "text/plain",
                "application/msword",
                "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            ];
            const maxSize = 10 * 1024 * 1024; // 10MB

            if (!validTypes.includes(file.type)) {
                showError(`File "${file.name}" is not a supported type. Please upload images, PDFs, or document files.`);
                return false;
            }

            if (file.size > maxSize) {
                showError(`File "${file.name}" is too large. Maximum file size is 10MB.`);
                return false;
            }

            return true;
        });

        files = [...files, ...validFiles];
        fileDropActive = false;
    }

    function removeFile(index) {
        files = files.filter((_, i) => i !== index);
    }

    function initializeStatusForm() {
        const statusSelect = document.getElementById("new_status");
        if (!statusSelect) return;

        updateResolutionVisibility(statusSelect.value);
        statusSelect.addEventListener("change", function(e) {
            updateResolutionVisibility(e.target.value);
        });
    }

    function updateResolutionVisibility(status) {
        const resolutionContainer = document.getElementById("resolution-summary-container");
        if (!resolutionContainer) return;

        const requiresResolution = ["resolved", "closed"].includes(status);

        if (requiresResolution) {
            resolutionContainer.classList.remove("hidden");
        } else {
            resolutionContainer.classList.add("hidden");
            const textarea = document.getElementById("resolution_summary");
            if (textarea) textarea.value = "";
            clearError("resolution_summary");
        }
    }

    function showError(message, field = null) {
        if (field) {
            formErrors[field] = message;
            const element = document.getElementById(field);
            if (element) {
                element.classList.add("border-red-500", "focus:border-red-500", "focus:ring-red-500");
            }

            // Show error notification
            const errorNotifications = document.getElementById('errorNotifications');
            const errorMessage = document.getElementById('errorMessage');
            if (errorNotifications && errorMessage) {
                errorMessage.textContent = message;
                errorNotifications.style.display = 'block';

                setTimeout(() => {
                    errorNotifications.style.display = 'none';
                }, 5000);
            }
        } else {
            alert(message);
        }
    }

    function clearError(field) {
        if (formErrors[field]) {
            delete formErrors[field];
            const element = document.getElementById(field);
            if (element) {
                element.classList.remove("border-red-500", "focus:border-red-500", "focus:ring-red-500");
            }
        }
    }

    function validateStatusForm() {
        const statusSelect = document.getElementById("new_status");
        const resolutionTextarea = document.getElementById("resolution_summary");

        if (!statusSelect || !resolutionTextarea) return true;

        const requiresResolution = ["resolved", "closed"].includes(statusSelect.value);
        if (requiresResolution && !resolutionTextarea.value.trim()) {
            showError("Please provide a resolution summary before closing or resolving the ticket.", "resolution_summary");
            resolutionTextarea.focus();
            return false;
        }

        clearError("resolution_summary");
        return true;
    }

    function setupFormHandlers() {
        setupAssignmentForm();
        setupCommentForm();
    }

    async function setupAssignmentForm() {
        const groupSelect = document.getElementById("assigned_group");
        const userSelect = document.getElementById("assigned_to_user");

        if (!groupSelect || !userSelect) return;

        const loadUsers = async (groupId) => {
            userSelect.innerHTML = '<option value="">Loading users...</option>';
            userSelect.disabled = true;

            try {
                const response = await fetch(`/api/users-by-group/${groupId}/`);
                if (!response.ok) throw new Error("Failed to fetch users");

                const users = await response.json();
                userSelect.innerHTML = '<option value="">Select User</option>';
                users.forEach(user => {
                    const option = new Option(
                        user.full_name || user.username,
                        user.id,
                        false,
                        user.id === userSelect.dataset.currentUser
                    );
                    userSelect.add(option);
                });
            } catch (error) {
                console.error("Error loading users:", error);
                userSelect.innerHTML = '<option value="">Error loading users</option>';
                showError("Failed to load users for the selected group");
            } finally {
                userSelect.disabled = false;
            }
        };

        // Load users for initial group selection
        if (groupSelect.value) {
            await loadUsers(groupSelect.value);
        }

        groupSelect.addEventListener("change", async function() {
            if (this.value) {
                await loadUsers(this.value);
            } else {
                userSelect.innerHTML = '<option value="">Select User</option>';
            }
        });
    }

    function setupCommentForm() {
        const commentForm = document.querySelector('form[name="comment-form"]');
        if (!commentForm) return;

        commentForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            if (loading) return;

            const comment = commentForm.querySelector("#comment").value.trim();
            if (!comment) {
                showError("Please enter a comment", "comment");
                return;
            }

            setLoading(true);
            const formData = new FormData(commentForm);

            // Append files if any
            files.forEach(file => {
                formData.append("files[]", file);
            });

            try {
                const response = await fetch(commentForm.action, {
                    method: "POST",
                    body: formData,
                });

                if (!response.ok) throw new Error("Failed to submit comment");
                window.location.reload();
            } catch (error) {
                console.error("Error:", error);
                showError("Failed to submit comment. Please try again.");
            } finally {
                setLoading(false);
            }
        });
    }

    function setLoading(isLoading) {
        loading = isLoading;
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        }
    }

    async function confirmReopen() {
        if (!confirm("Are you sure you want to reopen this ticket?")) return;
        await performTicketAction("reopen");
    }

    async function confirmEscalate() {
        if (!confirm("Are you sure you want to escalate this ticket?")) return;
        await performTicketAction("escalate");
    }

    async function performTicketAction(action) {
        setLoading(true);
        try {
            const response = await fetch(`/api/tickets/${ticket_id}/${action}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                    "Content-Type": "application/json",
                },
            });

            const data = await response.json();
            if (data.success) {
                window.location.reload();
            } else {
                showError(data.error || `Failed to ${action} ticket`);
            }
        } catch (error) {
            console.error("Error:", error);
            showError(`An error occurred while attempting to ${action} the ticket`);
        } finally {
            setLoading(false);
        }
    }

    function showFilePreview(url) {
        selectedImage = url;
        const modal = document.getElementById('filePreviewModal');
        const img = document.getElementById('previewImage');
        if (modal && img) {
            img.src = url;
            modal.style.display = 'flex';
        }
    }

    function closePreview() {
        selectedImage = null;
        const modal = document.getElementById('filePreviewModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}
