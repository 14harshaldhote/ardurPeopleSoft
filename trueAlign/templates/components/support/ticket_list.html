{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="md:flex md:items-center md:justify-between">
            <div class="flex-1 min-w-0">
                <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">Support Tickets</h2>
            </div>
            <div class="mt-4 flex md:mt-0 md:ml-4 space-x-3">
                <a href="{% url 'aps_support:create_ticket' %}"
                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Create New Ticket
                </a>
                <a href="{% url 'aps_support:ticket_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Export
                </a>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="mt-8 bg-white rounded-lg shadow">
            <div class="px-4 py-5 sm:p-6">
                <form method="GET" class="space-y-8 divide-y divide-gray-200">
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-2">
                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select name="status" id="status"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">All Status</option>
                                {% for value, display in status_choices %}
                                <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="sm:col-span-2">
                            <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                            <select name="priority" id="priority"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">All Priorities</option>
                                {% for value, display in priority_choices %}
                                <option value="{{ value }}" {% if current_filters.priority == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="sm:col-span-2">
                            <label for="issue_type" class="block text-sm font-medium text-gray-700">Issue Type</label>
                            <select name="issue_type" id="issue_type"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">All Types</option>
                                {% for value, display in issue_type_choices %}
                                <option value="{{ value }}" {% if current_filters.issue_type == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="sm:col-span-2">
                            <label for="assigned_to" class="block text-sm font-medium text-gray-700">Assigned To</label>
                            <select name="assigned_to" id="assigned_to"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">All Users</option>
                                <option value="me" {% if current_filters.assigned_to == 'me' %}selected{% endif %}>My
                                    Tickets</option>
                                <option value="unassigned" {% if current_filters.assigned_to == 'unassigned' %}selected{% endif %}>Unassigned</option>
                                {% for user in assignable_users %}
                                <option value="{{ user.pk }}" {% if current_filters.assigned_to == user.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ user.get_full_name|default:user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="sm:col-span-2">
                            <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
                            <input type="text" name="search" id="search"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                placeholder="Search tickets..." value="{{ current_filters.search }}">
                        </div>

                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">&nbsp;</label>
                            <div class="flex space-x-3">
                                <button type="submit"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Filter
                                </button>
                                <a href="{% url 'aps_support:ticket_list' %}"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                    Clear
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bulk Actions -->
        {% if user_roles.is_admin or user_roles.is_hr %}
        <div class="mt-8 bg-white rounded-lg shadow">
            <div class="px-4 py-5 sm:p-6">
                <form method="POST" action="{% url 'aps_support:bulk_ticket_actions' %}" id="bulkActionForm">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-2">
                            <label for="bulk_action" class="block text-sm font-medium text-gray-700">Bulk Action</label>
                            <select name="bulk_action" id="bulk_action"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">Select Action</option>
                                <option value="assign">Assign</option>
                                <option value="status_change">Change Status</option>
                                <option value="priority_change">Change Priority</option>
                                {% if user_roles.is_admin %}
                                <option value="delete">Delete</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="sm:col-span-2" id="bulk_assigned_to_field" style="display: none;">
                            <label for="bulk_assigned_to" class="block text-sm font-medium text-gray-700">Assign
                                To</label>
                            <select name="bulk_assigned_to" id="bulk_assigned_to"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">Select User</option>
                                {% for user in assignable_users %}
                                <option value="{{ user.pk }}">{{ user.get_full_name|default:user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="sm:col-span-2" id="bulk_status_field" style="display: none;">
                            <label for="bulk_status" class="block text-sm font-medium text-gray-700">New Status</label>
                            <select name="bulk_status" id="bulk_status"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                {% for value, display in status_choices %}
                                <option value="{{ value }}">{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="sm:col-span-2" id="bulk_priority_field" style="display: none;">
                            <label for="bulk_priority" class="block text-sm font-medium text-gray-700">New
                                Priority</label>
                            <select name="bulk_priority" id="bulk_priority"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                {% for value, display in priority_choices %}
                                <option value="{{ value }}">{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="sm:col-span-2">
                            <button type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                id="bulk_submit" disabled>
                                Apply
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Tickets Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                    <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    {% if user_roles.is_admin or user_roles.is_hr %}
                                    <!-- Replace the existing checkbox header cell with this -->
                                    <th scope="col" class="relative px-6 py-3">
                                        <input type="checkbox" id="select_all"
                                            class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </th>
                                    {% endif %}
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        ID</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Subject</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Status</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Priority</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Issue Type</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Created By</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Assigned To</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Created</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        SLA</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for ticket in tickets %}
                                <tr class="hover:bg-gray-50">
                                    {% if user_roles.is_admin or user_roles.is_hr %}
                                    <!-- Replace the existing checkbox cell in the ticket row with this -->
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox"
                                            class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 ticket-checkbox"
                                            name="selected_tickets[]" value="{{ ticket.pk }}">
                                    </td>
                                    {% endif %}
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-medium text-gray-900">{{ ticket.ticket_id }}</span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <a href="{% url 'aps_support:ticket_detail' ticket.pk %}"
                                            class="text-sm text-indigo-600 hover:text-indigo-900">
                                            {{ ticket.subject|truncatechars:50 }}
                                        </a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                            {% if ticket.status == 'new' %}bg-blue-100 text-blue-800
                                            {% elif ticket.status == 'open' %}bg-yellow-100 text-yellow-800
                                            {% elif ticket.status == 'in_progress' %}bg-indigo-100 text-indigo-800
                                            {% elif ticket.status == 'resolved' %}bg-green-100 text-green-800
                                            {% elif ticket.status == 'closed' %}bg-gray-100 text-gray-800
                                            {% elif ticket.status == 'pending_user' %}bg-orange-100 text-orange-800
                                            {% elif ticket.status == 'on_hold' %}bg-purple-100 text-purple-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ ticket.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                            {% if ticket.priority == 'critical' %}bg-red-100 text-red-800
                                            {% elif ticket.priority == 'high' %}bg-yellow-100 text-yellow-800
                                            {% elif ticket.priority == 'medium' %}bg-blue-100 text-blue-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ ticket.get_priority_display }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">{{ ticket.get_issue_type_display }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">{{
                                        ticket.user.get_full_name|default:ticket.user.username }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">{{
                                        ticket.assigned_to_user.get_full_name|default:"Unassigned" }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">{{ ticket.created_at|date:"M d, Y H:i" }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if ticket.sla_target_date %}
                                        {% if ticket.resolved_at %}
                                        {% if ticket.resolved_at <= ticket.sla_target_date %} <span
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Met</span>
                                            {% else %}
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Breached</span>
                                            {% endif %}
                                            {% else %}
                                            {% now "c" as now %}
                                            {% if ticket.sla_target_date|date:'c' < now %} <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                Breached</span>
                                                {% else %}
                                                <span
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">On
                                                    Track</span>
                                                {% endif %}
                                                {% endif %}
                                                {% else %}
                                                <span
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">N/A</span>
                                                {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex space-x-2">
                                            <a href="{% url 'aps_support:ticket_detail' ticket.pk %}"
                                                class="inline-flex items-center px-3 py-1.5 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                View
                                            </a>
                                            {% if ticket.status in 'resolved,closed' and ticket.user == user %}
                                            <button type="button"
                                                class="inline-flex items-center px-3 py-1.5 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-warning-600 hover:bg-warning-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-warning-500"
                                                onclick="reopenTicket({{ ticket.pk }})">
                                                Reopen
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{% if user_roles.is_admin or user_roles.is_hr %}11{% else %}10{% endif %}"
                                        class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                        No tickets found matching your criteria.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        {% if tickets.has_other_pages %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 rounded-b-lg">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if tickets.has_previous %}
                <a href="?page={{ tickets.previous_page_number }}"
                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </a>
                {% endif %}
                {% if tickets.has_next %}
                <a href="?page={{ tickets.next_page_number }}"
                    class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing page <span class="font-medium">{{ tickets.number }}</span> of
                        <span class="font-medium">{{ tickets.paginator.num_pages }}</span>
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        <!-- Pagination links -->
                        {% if tickets.has_previous %}
                        <a href="?page=1"
                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">First</span>
                            <!-- Heroicon name: mini.chevron-left -->
                            <svg class="-ml-0.5 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 6l-6 6 6 6" />
                            </svg>
                        </a>
                        <a href="?page={{ tickets.previous_page_number }}"
                            class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <!-- Heroicon name: mini.chevron-left -->
                            <svg class="-ml-0.5 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 6l-6 6 6 6" />
                            </svg>
                        </a>
                        {% endif %}
                        <span class="hidden sm:block">
                            {% for num in tickets.paginator.page_range %}
                            {% if tickets.number == num %}
                            <span aria-current="page"
                                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-600 text-sm font-medium text-white">
                                {{ num }}
                            </span>
                            {% else %}
                            <a href="?page={{ num }}"
                                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                {{ num }}
                            </a>
                            {% endif %}
                            {% endfor %}
                        </span>
                        {% if tickets.has_next %}
                        <a href="?page={{ tickets.next_page_number }}"
                            class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <!-- Heroicon name: mini.chevron-right -->
                            <svg class="-mr-0.5 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 6l6 6-6 6" />
                            </svg>
                        </a>
                        <a href="?page={{ tickets.paginator.num_pages }}"
                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Last</span>
                            <!-- Heroicon name: mini.chevron-right -->
                            <svg class="-mr-0.5 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 6l6 6-6 6" />
                            </svg>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form elements
    const bulkActionForm = document.getElementById('bulkActionForm');
    const bulkActionSelect = document.getElementById('bulk_action');
    const selectAllCheckbox = document.getElementById('select_all');
    const bulkSubmitButton = document.getElementById('bulk_submit');
    const assignField = document.getElementById('bulk_assigned_to_field');
    const statusField = document.getElementById('bulk_status_field');
    const priorityField = document.getElementById('bulk_priority_field');
    
    // Initialize timestamp for activity tracking
    let lastActivityTime = new Date('2025-06-08T07:56:44Z');
    
    // Activity tracking function
    function updateActivity() {
        const currentTime = new Date();
        if ((currentTime - lastActivityTime) >= 30000) { // 30 seconds
            fetch('/update-activity/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    last_active: currentTime.toISOString()
                })
            });
            lastActivityTime = currentTime;
        }
    }

    // Set up activity tracking
    document.addEventListener('mousemove', updateActivity);
    document.addEventListener('keydown', updateActivity);
    setInterval(updateActivity, 30000); // Backup checker every 30 seconds

    // Bulk action change handler
    bulkActionSelect?.addEventListener('change', function() {
        const action = this.value;
        
        // Hide all fields first
        [assignField, statusField, priorityField].forEach(field => {
            if (field) field.style.display = 'none';
        });
        
        // Show relevant field
        switch(action) {
            case 'assign':
                assignField.style.display = 'block';
                break;
            case 'status_change':
                statusField.style.display = 'block';
                break;
            case 'priority_change':
                priorityField.style.display = 'block';
                break;
        }
        
        updateBulkSubmitButton();
    });
    
    // Select all checkbox handler
    selectAllCheckbox?.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.ticket-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkSubmitButton();
    });
    
    // Individual checkbox handlers
    document.querySelectorAll('.ticket-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const totalCheckboxes = document.querySelectorAll('.ticket-checkbox').length;
            const checkedCheckboxes = document.querySelectorAll('.ticket-checkbox:checked').length;
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = totalCheckboxes === checkedCheckboxes;
                selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
            }
            updateBulkSubmitButton();
        });
    });
    
    // Update submit button state
    function updateBulkSubmitButton() {
        const selectedTickets = document.querySelectorAll('.ticket-checkbox:checked').length;
        const bulkAction = bulkActionSelect?.value;
        
        if (bulkSubmitButton) {
            bulkSubmitButton.disabled = selectedTickets === 0 || !bulkAction;
            
            // Update button appearance based on state
            if (bulkSubmitButton.disabled) {
                bulkSubmitButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                bulkSubmitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    }
    
    // Form submission handler
    bulkActionForm?.addEventListener('submit', function(e) {
        e.preventDefault();
        updateActivity(); // Track this action
        
        const selectedCheckboxes = document.querySelectorAll('.ticket-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one ticket.');
            return;
        }
        
        const action = bulkActionSelect.value;
        if (!action) {
            alert('Please select a bulk action.');
            return;
        }
        
        // Validate additional fields based on action
        if (action === 'assign') {
            const assignedTo = document.getElementById('bulk_assigned_to')?.value;
            if (!assignedTo) {
                alert('Please select a user to assign the tickets to.');
                return;
            }
        } else if (action === 'status_change') {
            const newStatus = document.getElementById('bulk_status')?.value;
            if (!newStatus) {
                alert('Please select a new status.');
                return;
            }
        } else if (action === 'priority_change') {
            const newPriority = document.getElementById('bulk_priority')?.value;
            if (!newPriority) {
                alert('Please select a new priority.');
                return;
            }
        }
        
        if (!confirm(`Are you sure you want to apply "${action}" to ${selectedCheckboxes.length} ticket(s)?`)) {
            return;
        }
        
        // Disable form while processing
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = 'Processing...';
        
        // Create FormData and append selected tickets
        const formData = new FormData(this);
        formData.delete('selected_tickets'); // Remove any existing values
        selectedCheckboxes.forEach(checkbox => {
            formData.append('selected_tickets', checkbox.value);
        });
        
        // Add current user info
        formData.append('user', 'initator16');
        
        // Submit the form
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                throw new Error(data.error || 'An error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || 'An error occurred while processing the request');
        })
        .finally(() => {
            // Re-enable form
            submitButton.disabled = false;
            submitButton.innerHTML = 'Apply';
        });
    });
    
    // Reopen ticket function
    window.reopenTicket = function(ticketId) {
        if (confirm('Are you sure you want to reopen this ticket?')) {
            updateActivity(); // Track this action
            
            fetch(`/support/tickets/${ticketId}/reopen/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user: 'initator16',
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    throw new Error(data.error || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message || 'Error reopening ticket');
            });
        }
    };
    
    // Initialize the submit button state
    updateBulkSubmitButton();
});
</script>
<script src="https://cdn.tailwindcss.com"></script>

{% endblock %}