{% extends 'base.html' %}

{% block content %}
<!-- User Profile Section -->
<div class="max-w-7xl mx-auto py-8 px-4">
    <!-- Profile Header -->
    <div class="flex justify-between items-center mb-8">
        <div class="flex items-center space-x-4">
            <a href="{% url 'aps_hr:hr_dashboard' %}" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
      
    </div>

    <!-- User Profile Card -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <!-- Profile Header -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <div class="h-16 w-16 rounded-full bg-white flex items-center justify-center text-xl font-bold text-indigo-600 shadow-md">
                        {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                    </div>
                    <div class="text-white">
                        <h1 class="text-2xl font-bold">{{ user.first_name }} {{ user.last_name }}</h1>
                        <p class="text-blue-100">Employee ID: {{ user.userdetails.employee_id }}</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3">
                    <button type="button" onclick="$('#changeStatusModal').modal('show')"
                        class="px-4 py-2 bg-white text-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors shadow-sm">
                        <i class="fas fa-exchange-alt mr-2"></i>Change Status
                    </button>
                    <button type="button" onclick="$('#changeRoleModal').modal('show')"
                        class="px-4 py-2 bg-white text-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors shadow-sm">
                        <i class="fas fa-user-tag mr-2"></i>Change Role
                    </button>
                    <button type="button" onclick="$('#resetPasswordModal').modal('show')"
                        class="px-4 py-2 bg-white text-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors shadow-sm">
                        <i class="fas fa-key mr-2"></i>Reset Password
                    </button>
                </div>
            </div>
        </div>

        <!-- User Details -->
        <div class="p-6">
            <!-- Basic Information -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Employee ID</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.employee_id|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Full Name</p>
                        <p class="font-medium text-gray-800">{{ user.first_name }} {{ user.last_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Email</p>
                        <p class="font-medium text-gray-800">{{ user.email|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Role</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.role|default:"Employee" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Status</p>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                            {% if user.userdetails.employment_status == 'active' %}bg-green-100 text-green-700
                            {% elif user.userdetails.employment_status == 'inactive' %}bg-gray-100 text-gray-700
                            {% elif user.userdetails.employment_status == 'terminated' %}bg-red-100 text-red-700
                            {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            <span class="w-2 h-2 rounded-full mr-2 
                                {% if user.userdetails.employment_status == 'active' %}bg-green-500
                                {% elif user.userdetails.employment_status == 'inactive' %}bg-gray-500
                                {% elif user.userdetails.employment_status == 'terminated' %}bg-red-500
                                {% else %}bg-yellow-500{% endif %}">
                            </span>
                            {{ user.userdetails.employment_status|title|default:"Unknown" }}
                        </span>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Account Active</p>
                        <p class="font-medium text-gray-800">{{ user.is_active|yesno:"Yes,No" }}</p>
                    </div>
                </div>
            </div>

            <!-- Employment Information -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Employment Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Work Location</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.work_location|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Hire Date</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.hire_date|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Start Date</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.start_date|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Employment Duration</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.employment_duration|default:"-" }}</p>
                    </div>
                    <div class="col-span-full">
                        <p class="text-sm text-gray-500 mb-1">Job Description</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.job_description|default:"-" }}</p>
                    </div>
                </div>
            </div>

            <!-- Personal Details -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Personal Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Gender</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.gender|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Date of Birth</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.date_of_birth|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Blood Group</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.blood_group|default:"Unknown" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Contact Number</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.contact_number|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Personal Email</p>
                        <p class="font-medium text-gray-800">{{ user.userdetails.personal_email|default:"-" }}</p>
                    </div>
                </div>
            </div>

            <!-- Activity Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recent Activity -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Recent Activity</h2>
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800">View All</a>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">Date</th>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">Action</th>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">By</th>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if activity_logs %}
                                    {% for log in activity_logs %}
                                    <tr>
                                        <td class="py-2 text-sm text-gray-700">{{ log.date }}</td>
                                        <td class="py-2 text-sm text-gray-700">{{ log.action }}</td>
                                        <td class="py-2 text-sm text-gray-700">{{ log.by }}</td>
                                        <td class="py-2 text-sm text-gray-700">{{ log.details }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="py-4 text-sm text-gray-500 text-center">No activity logs found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Login Sessions -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Recent Login Sessions</h2>
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800">View All</a>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">Login Time</th>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">Logout Time</th>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">Location</th>
                                    <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3">Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if login_sessions %}
                                    {% for session in login_sessions %}
                                    <tr>
                                        <td class="py-2 text-sm text-gray-700">{{ session.login_time }}</td>
                                        <td class="py-2 text-sm text-gray-700">{{ session.logout_time }}</td>
                                        <td class="py-2 text-sm text-gray-700">{{ session.location }}</td>
                                        <td class="py-2 text-sm text-gray-700">{{ session.duration }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="py-4 text-sm text-gray-500 text-center">No login sessions found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Details Section -->
    <div class="mt-8 bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4">
            <h2 class="text-xl font-semibold text-white">Edit User Details</h2>
        </div>
        <div class="p-6">
            <form action="" method="post">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" name="email" value="{{ user.email }}" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Change Status Modal -->
<div class="modal" id="changeStatusModal" tabindex="-1" role="dialog" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content rounded-lg shadow-lg">
            <div class="modal-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                <h5 class="modal-title" id="changeStatusModalLabel">Change Employment Status</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" onclick="$('#changeStatusModal').modal('hide')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form action="{% url 'aps_hr:change_user_status' user.id %}" method="post">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="current_status" class="block text-sm font-medium text-gray-700 mb-1">Current Status</label>
                        <input type="text" id="current_status" value="{{ user.userdetails.employment_status|title|default:'Unknown' }}" 
                            class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="new_status" class="block text-sm font-medium text-gray-700 mb-1">New Status</label>
                        <select id="new_status" name="new_status" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" selected disabled>Select Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="terminated">Terminated</option>
                            <option value="resigned">Resigned</option>
                            <option value="suspended">Suspended</option>
                            <option value="absconding">Absconding</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="status_reason" class="block text-sm font-medium text-gray-700 mb-1">Reason for Change</label>
                        <textarea id="status_reason" name="status_reason" rows="3" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" onclick="$('#changeStatusModal').modal('hide')">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div class="modal" id="changeRoleModal" tabindex="-1" role="dialog" aria-labelledby="changeRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content rounded-lg shadow-lg">
            <div class="modal-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                <h5 class="modal-title" id="changeRoleModalLabel">Change User Role</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" onclick="$('#changeRoleModal').modal('hide')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form action="{% url 'aps_hr:change_user_role' user.id %}" method="post">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="current_role" class="block text-sm font-medium text-gray-700 mb-1">Current Role</label>
                        <input type="text" id="current_role" value="{{ user.userdetails.role|default:'Employee' }}" 
                            class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="new_role" class="block text-sm font-medium text-gray-700 mb-1">New Role</label>
                        <select id="new_role" name="new_role" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" selected disabled>Select Role</option>
                            <option value="Admin">Admin</option>
                            <option value="Backoffice">Backoffice</option>
                            <option value="Client">Client</option>
                            <option value="Employee">Employee</option>
                            <option value="Finance">Finance</option>
                            <option value="HR">HR</option>
                            <option value="Management">Management</option>
                            <option value="Manager">Manager</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="role_reason" class="block text-sm font-medium text-gray-700 mb-1">Reason for Change</label>
                        <textarea id="role_reason" name="role_reason" rows="3" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="text-sm text-gray-500 mb-4">
                        <p>Changing a user's role will affect their permissions and access levels in the system.</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" onclick="$('#changeRoleModal').modal('hide')">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal" id="resetPasswordModal" tabindex="-1" role="dialog" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content rounded-lg shadow-lg">
            <div class="modal-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                <h5 class="modal-title" id="resetPasswordModalLabel">Reset User Password</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" onclick="$('#resetPasswordModal').modal('hide')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form action="{% url 'aps_hr:reset_user_password' user.id %}" method="post" id="resetPasswordForm">
                    {% csrf_token %}
                    <div class="mb-4 text-center">
                        <p class="text-gray-700">You are about to reset the password for: <strong>{{ user.userdetails.employee_id }}</strong></p>
                    </div>
                    <div class="mb-4">
                        <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                        <input type="password" id="new_password" name="new_password" required minlength="8"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Password must be at least 8 characters long.</p>
                    </div>
                    <div class="mb-4">
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                        <input type="password" id="confirm_password" name="confirm_password" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-red-500 mt-1" id="password-mismatch" style="display: none;">Passwords do not match.</p>
                    </div>
                    <div class="text-sm text-gray-500 mb-4">
                        <p>The user will receive an email with their new password.</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" onclick="$('#resetPasswordModal').modal('hide')">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Reset Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize modals
    $('.modal').modal({
        show: false,
        backdrop: 'static',
        keyboard: false
    });
    
    // Password validation
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const mismatchMessage = document.getElementById('password-mismatch');
    const resetForm = document.getElementById('resetPasswordForm');
    
    resetForm.addEventListener('submit', function(e) {
        if (newPassword.value !== confirmPassword.value) {
            e.preventDefault();
            mismatchMessage.style.display = 'block';
        } else {
            mismatchMessage.style.display = 'none';
        }
    });
    
    confirmPassword.addEventListener('input', function() {
        if (newPassword.value !== confirmPassword.value) {
            mismatchMessage.style.display = 'block';
        } else {
            mismatchMessage.style.display = 'none';
        }
    });
});
</script>
{% endblock %}