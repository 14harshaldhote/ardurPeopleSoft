{% extends 'base.html' %}
{% load static %}

{% block title %}Transactions & Journal Entries{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <div class="flex items-center justify-between mb-8 mt-8">
        <h1 class="text-3xl font-bold text-gray-800">Transactions & Journal Entries</h1>
        <div class="flex space-x-4">
            <button id="toggleFormBtn" type="button" onclick="toggleTransactionForm()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                <i class="fas fa-plus mr-2"></i>
                New Transaction
            </button>
            <button type="button" onclick="exportTransactions()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                <i class="fas fa-download mr-2"></i>
                Export
            </button>
        </div>
    </div>

    <!-- Add New Transaction Form -->
    <div id="transactionForm" class="bg-white rounded-lg shadow-lg mb-8 transform transition-all duration-300 scale-100 opacity-100" style="display: none;">
        <div class="px-6 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 border-b border-gray-200 rounded-t-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-plus text-white mr-2"></i>
                    <span class="text-xl font-semibold text-white">Add New Transaction</span>
                </div>
                <button id="closeFormBtn" type="button" onclick="closeTransactionForm()" class="text-white hover:text-gray-200 transition-colors duration-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form method="post" class="space-y-6" id="transactionEntryForm">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="transition-all duration-200 hover:shadow-md p-4 rounded-lg">
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Transaction Type</label>
                        <select name="type" id="type" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                            {% for type_code, type_name in transaction_types %}
                                <option value="{{ type_code }}">{{ type_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="transition-all duration-200 hover:shadow-md p-4 rounded-lg">
                        <label for="account" class="block text-sm font-medium text-gray-700 mb-2">Account</label>
                        <select name="account" id="account" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                            <option value="">Select Account</option>
                            {% for account in accounts %}
                                <option value="{{ account.id }}">{{ account.code }} - {{ account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="toAccountDiv" class="transition-all duration-200 hover:shadow-md p-4 rounded-lg" style="display: none;">
                        <label for="to_account" class="block text-sm font-medium text-gray-700 mb-2">To Account</label>
                        <select name="to_account" id="to_account" class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                            <option value="">Select Account</option>
                            {% for account in accounts %}
                                <option value="{{ account.id }}">{{ account.code }} - {{ account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="transition-all duration-200 hover:shadow-md p-4 rounded-lg">
                        <label for="project" class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                        <select name="project" id="project" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                            <option value="">Select Project</option>
                            {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="transition-all duration-200 hover:shadow-md p-4 rounded-lg">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <div class="relative rounded-lg">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">â‚¹</span>
                            <input type="number" step="0.01" name="amount" id="amount" required class="pl-8 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                        </div>
                    </div>
                    <div class="transition-all duration-200 hover:shadow-md p-4 rounded-lg">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <input type="text" name="description" id="description" required class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg shadow-md hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                        <i class="fas fa-check mr-2"></i>
                        Record Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transactions List -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200 rounded-t-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-list text-indigo-600 mr-2"></i>
                    <span class="text-xl font-semibold text-gray-700">Transaction History</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="tableSearch" placeholder="Search transactions..." class="w-64 rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 pl-10">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="transactionsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600 transition-colors duration-200">Date <i class="fas fa-sort ml-1"></i></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600 transition-colors duration-200">Type <i class="fas fa-sort ml-1"></i></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600 transition-colors duration-200">Account <i class="fas fa-sort ml-1"></i></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600 transition-colors duration-200">Project <i class="fas fa-sort ml-1"></i></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600 transition-colors duration-200">Amount <i class="fas fa-sort ml-1"></i></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for transaction in transactions %}
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transaction.date|date:"d M Y" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 rounded-full text-xs font-medium 
                                    {% if transaction.transaction_type == 'income' %}bg-green-100 text-green-800
                                    {% elif transaction.transaction_type == 'expense' %}bg-red-100 text-red-800
                                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ transaction.get_transaction_type_display }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transaction.account.name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transaction.project.name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transaction.description }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if transaction.transaction_type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                â‚¹{{ transaction.amount|floatformat:2 }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleTransactionForm() {
        const form = document.getElementById('transactionForm');
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }

    function closeTransactionForm() {
        document.getElementById('transactionForm').style.display = 'none';
    }

    function exportTransactions() {
        // Add your export logic here
        alert('Export functionality coming soon!');
    }

    $(document).ready(function() {
        // Initialize DataTable with custom styling
        const table = $('#transactionsTable').DataTable({
            order: [[0, 'desc']], 
            pageLength: 10,
            dom: '<"flex flex-col md:flex-row justify-between items-center mb-4"lf>rt<"flex flex-col md:flex-row justify-between items-center mt-4"ip>',
            language: {
                search: "",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    previous: '<i class="fas fa-chevron-left"></i>',
                    next: '<i class="fas fa-chevron-right"></i>'
                }
            }
        });

        // Custom search input
        $('#tableSearch').on('keyup', function() {
            table.search(this.value).draw();
        });

        // Show/hide to_account field with animation
        $('#type').change(function() {
            if ($(this).val() === 'transfer') {
                $('#toAccountDiv').slideDown(300);
                $('#to_account').prop('required', true);
            } else {
                $('#toAccountDiv').slideUp(300);
                $('#to_account').prop('required', false);
            }
        });

        // Form submission with animation
        $('#transactionEntryForm').submit(function() {
            $(this).find('button[type="submit"]').prop('disabled', true)
                .html('<i class="fas fa-spinner fa-spin mr-2"></i>Processing...');
        });

        // Add hover effects to table rows
        $('#transactionsTable tbody tr').hover(
            function() { $(this).addClass('transform scale-[1.01] shadow-sm'); },
            function() { $(this).removeClass('transform scale-[1.01] shadow-sm'); }
        );
    });
</script>
{% endblock %}
